<%- contentFor('content') %>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* Popup ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á - Modern Style */
  .room-popup {
      max-width: 480px !important;
      border-radius: 20px !important;
      border: 3px solid #333 !important;
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%) !important;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.05) inset !important;
      padding: 0 !important;
      overflow: hidden !important;
  }
  
  .room-popup .swal2-title {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      margin: 0 !important;
      padding: 20px 24px !important;
      font-family: 'Orbitron', sans-serif !important;
      font-size: 1.4em !important;
      font-weight: 700 !important;
      color: #fff !important;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }

  .room-popup .swal2-html-container {
      margin: 0 !important;
      padding: 24px !important;
      overflow: visible !important;
  }
  
  .room-popup .swal2-actions {
      padding: 0 24px 24px !important;
      gap: 12px !important;
  }
  
  .room-form-group {
      margin-bottom: 20px;
  }
  
  .room-form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-weight: 600;
      color: #aaa;
      font-size: 0.95em;
      font-family: 'Rajdhani', sans-serif;
  }
  
  .room-form-label .icon {
      font-size: 1.1em;
  }
  
  .room-form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #333;
      border-radius: 12px;
      background: #0d0d1a;
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1.1em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-sizing: border-box;
  }
  
  .room-form-input:focus {
      outline: none;
      border-color: #e74c3c;
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
  }
  
  .room-form-input::placeholder {
      color: #555;
      font-weight: 400;
  }
  
  /* Slider Style */
  .room-slider-container {
      position: relative;
      padding: 10px 0;
  }
  
  .room-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, #333 0%, #333 100%);
      outline: none;
      transition: all 0.3s;
  }
  
  .room-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      cursor: pointer;
      border: 3px solid #fff;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
      transition: all 0.2s;
  }
  
  .room-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
  }
  
  .room-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      cursor: pointer;
      border: 3px solid #fff;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
  }
  
  .room-slider-value {
      position: absolute;
      right: 0;
      top: -5px;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 1em;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
  }
  
  /* Button Styles */
  .room-btn-confirm {
      padding: 14px 28px !important;
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
      border: none !important;
      border-radius: 12px !important;
      color: #fff !important;
      font-family: 'Rajdhani', sans-serif !important;
      font-weight: 700 !important;
      font-size: 1.1em !important;
      cursor: pointer;
      transition: all 0.3s !important;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
  }
  
  .room-btn-confirm:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4) !important;
  }
  
  .room-btn-cancel {
      padding: 14px 28px !important;
      background: transparent !important;
      border: 2px solid #555 !important;
      border-radius: 12px !important;
      color: #aaa !important;
      font-family: 'Rajdhani', sans-serif !important;
      font-weight: 700 !important;
      font-size: 1.1em !important;
      cursor: pointer;
      transition: all 0.3s !important;
  }
  
  .room-btn-cancel:hover {
      border-color: #888 !important;
      color: #fff !important;
      background: rgba(255,255,255,0.05) !important;
  }

  /* Checkbox container for locked room */
  .room-checkbox-container {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #0d0d1a;
      border: 2px solid #333;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
  }
  
  .room-checkbox-container:hover {
      border-color: #555;
  }
  
  .room-checkbox-container.checked {
      border-color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
  }
  
  .room-checkbox {
      display: none;
  }
  
  .room-checkbox-custom {
      width: 24px;
      height: 24px;
      border: 2px solid #555;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: transparent;
      font-size: 14px;
      transition: all 0.3s;
  }
  
  .room-checkbox-container.checked .room-checkbox-custom {
      background: #e74c3c;
      border-color: #e74c3c;
      color: #fff;
  }
  
  .room-checkbox-text {
      flex: 1;
      font-weight: 600;
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1.05em;
  }

  .room-lobby-container {
    max-width: 1400px;
    margin: 20px auto 40px;
    padding: 10px 20px 30px;
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    overflow-x: hidden;
  }

  .room-lobby-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .room-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.6em;
    font-weight: 800;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
  }

  .room-meta {
    font-size: 0.95em;
    color: #ddd;
  }

  .room-meta span {
    margin-right: 12px;
  }

  .room-main-panel {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
  }

  .room-chat-area {
    flex: 1;
    min-width: 280px;
  }

  .lobby-player-list {
    flex: 0 0 280px;
    max-width: 300px;
  }

  .room-card-dark {
    background: linear-gradient(135deg, #151515 0%, #222 100%);
    border-radius: 16px;
    border: 2px solid #444;
    box-shadow: 0 10px 30px rgba(0,0,0,0.7);
    padding: 18px 20px 16px;
  }

  .room-chat-area.room-card-dark {
    height: 380px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Mobile responsive for room lobby */
  @media (max-width: 768px) {
    .room-main-panel {
      flex-direction: column;
    }
    
    .room-chat-area {
      min-width: 100%;
      height: 280px !important;
      max-height: 280px;
    }
    
    .lobby-player-list {
      flex: 1 1 100%;
      max-width: 100%;
    }
  }

  .room-chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
    margin-bottom: 10px;
    font-size: 0.95em;
    min-height: 0;
    max-height: calc(100% - 60px);
    word-wrap: break-word;
    word-break: break-word;
  }

  .room-chat-input-row {
    display: flex;
    gap: 8px;
    margin-top: 4px;
  }

  #lobbyChatInput {
    flex: 1;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid #444;
    background: #111;
    color: #fff;
    resize: none;
    min-height: 34px;
    max-height: 90px;
  }

  #lobbyChatInput:focus {
    outline: none;
    border-color: #e74c3c;
  }

  .btn-send-chat {
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    background: #e74c3c;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    font-size: 0.9em;
  }

  .btn-send-chat:active {
    transform: translateY(1px);
  }

  .lobby-player-list h3 {
    font-size: 1.1em;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .lobby-player-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed #333;
    font-size: 0.95em;
  }

  .lobby-player-main {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .lobby-player-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #2ecc71;
  }

  .lobby-player-name {
    font-weight: 600;
  }

  .lobby-player-role {
    font-size: 0.8em;
    color: #ffdd59;
  }

  .lobby-player-admin-badge {
    font-size: 0.8em;
    color: #f39c12;
  }

  .player-action-icons {
    display: flex;
    gap: 8px;
    margin-left: auto;
  }

  .player-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1em;
    padding: 4px 6px;
    border-radius: 6px;
    transition: all 0.2s;
    opacity: 0.7;
  }

  .player-action-btn:hover {
    opacity: 1;
    transform: scale(1.2);
  }

  .player-action-btn.kick-btn:hover {
    background: rgba(231, 76, 60, 0.3);
  }

  .player-action-btn.crown-btn:hover {
    background: rgba(243, 156, 18, 0.3);
  }

  .lobby-admin-controls {
    margin-top: 12px;
    border-top: 1px solid #333;
    padding-top: 8px;
  }

  .lobby-admin-controls h4 {
    font-size: 1em;
    margin-bottom: 6px;
  }

  .btn-admin-small {
    width: 100%;
    margin-bottom: 6px;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    font-size: 0.9em;
    cursor: pointer;
  }

  .btn-kick {
    background: #e74c3c;
    color: #fff;
  }

  .btn-transfer {
    background: #3498db;
    color: #fff;
  }

  .btn-edit-room {
    background: #f39c12;
    color: #111;
  }

  .start-game-bar {
    margin-top: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-shrink: 0; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö */
    min-height: 50px;
  }

  .start-game-bar span {
    font-size: 0.95em;
    color: #ddd;
  }

  #btnStartGameLobby {
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 1em;
    cursor: pointer;
    background: #2ecc71;
    color: #111;
  }

  #btnStartGameLobby:disabled {
    background: #555;
    color: #aaa;
    cursor: not-allowed;
  }

  .chat-msg {
    margin-bottom: 12px;
    display: flex;
    flex-direction: row;
    gap: 8px;
    max-width: 90%;
  }

  .chat-msg.my-msg {
    align-self: flex-end;
    margin-left: auto;
    flex-direction: row-reverse;
  }

  .chat-msg.other-msg {
    align-self: flex-start;
    margin-right: auto;
  }

  .chat-msg.system-msg {
    align-self: center;
    max-width: 100%;
    text-align: center;
    flex-direction: column;
  }
  
  .chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 2px solid;
  }
  
  .chat-avatar:hover {
    transform: scale(1.15);
    box-shadow: 0 0 10px rgba(255,255,255,0.3);
  }
  
  .chat-content {
    display: flex;
    flex-direction: column;
  }

  .chat-msg-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    word-wrap: break-word;
  }

  .chat-msg.my-msg .chat-msg-bubble {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border-bottom-right-radius: 4px;
  }

  .chat-msg.other-msg .chat-msg-bubble {
    background: #3a3a3a;
    border-bottom-left-radius: 4px;
  }

  .chat-msg.system-msg .chat-msg-bubble {
    background: rgba(243, 156, 18, 0.2);
    border: 1px solid #f39c12;
    font-style: italic;
  }

  .chat-msg-name {
    font-weight: 700;
    margin-bottom: 2px;
    font-size: 0.85em;
    cursor: pointer;
    transition: color 0.2s;
  }
  
  .chat-msg-name:hover {
    text-decoration: underline;
  }

  .chat-msg-text {
    font-size: 0.95em;
  }

  .chat-msg-meta {
    font-size: 0.7em;
    color: #888;
    margin-top: 3px;
  }

  .chat-msg.my-msg .chat-msg-meta {
    text-align: right;
  }

  .room-chat-messages {
    display: flex;
    flex-direction: column;
  }
  
  /* Clickable Avatar */
  .clickable-avatar {
    transition: transform 0.2s;
  }
  
  .clickable-avatar:hover {
    transform: scale(1.3);
  }
  
  /* Profile Modal */
  .profile-modal-content {
    text-align: left;
    font-family: 'Rajdhani', sans-serif;
  }
  
  .profile-modal-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 2px solid #333;
  }
  
  .profile-modal-avatar {
    position: relative;
    width: 70px;
    height: 70px;
  }
  
  .profile-modal-avatar-inner {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2em;
    border: 3px solid;
    position: relative;
    z-index: 2;
  }
  
  .profile-modal-avatar-frame {
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border-radius: 50%;
    z-index: 1;
  }
  
  .profile-modal-name {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 1.3em;
    margin: 0;
  }
  
  .profile-modal-joined {
    color: #888;
    font-size: 0.85em;
  }
  
  .profile-modal-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .profile-stat-box {
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    text-align: center;
  }
  
  .profile-stat-value {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 1.3em;
  }
  
  .profile-stat-label {
    color: #888;
    font-size: 0.8em;
  }
  
  .profile-roles {
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
  }
  
  .profile-roles h4 {
    margin: 0 0 8px 0;
    color: #f39c12;
    font-size: 0.95em;
  }
  
  .profile-role-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #333;
    font-size: 0.9em;
  }
  
  .profile-role-row:last-child {
    border-bottom: none;
  }
</style>

<div class="room-lobby-container">
  <div class="room-lobby-header">
    <div>
      <div class="room-title">üéÆ ‡∏´‡πâ‡∏≠‡∏á: <%= room.name %></div>
      <div class="room-meta">
        <span>ID: <strong><%= room.roomId %></strong></span>
        <span>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <strong id="lobbyPlayerCount"><%= room.playerCount %></strong>/<%= room.maxPlayers %></span>
        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong id="lobbyRoomLock"><%= room.locked ? 'üîí ‡∏•‡πá‡∏≠‡∏Ñ' : 'üîì ‡πÄ‡∏õ‡∏¥‡∏î' %></strong></span>
      </div>
    </div>
    <div>
      <button id="btnLeaveRoom" class="btn btn-dark" style="font-family: 'Rajdhani', sans-serif;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Room List</button>
    </div>
  </div>

  <div class="room-main-panel">
    <!-- Chat / status -->
    <div class="room-card-dark room-chat-area">
      <div style="margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center;">
        <div>üí¨ ‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</div>
        <div style="font-size:0.85em; color:#aaa;">‡∏Ñ‡∏∏‡∏ì: <span style="color:<%= playerInfo.color %>;"><%= player.name %></span></div>
      </div>
      <div id="lobbyChatMessages" class="room-chat-messages"></div>
      <div class="room-chat-input-row">
        <textarea id="lobbyChatInput" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."></textarea>
        <button id="btnSendLobbyChat" class="btn-send-chat">‡∏™‡πà‡∏á</button>
      </div>
      <div class="start-game-bar">
        <span id="lobbyStatusText">
          ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
        </span>
        <button id="btnStartGameLobby" disabled style="display: <%= room.isAdmin ? 'inline-block' : 'none' %>;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      </div>
    </div>

    <!-- Players / admin controls -->
    <div class="room-card-dark lobby-player-list">
      <h3>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h3>
      <div id="lobbyPlayers"></div>

      <div id="adminControlsSection" class="lobby-admin-controls" style="display: <%= room.isAdmin ? 'block' : 'none' %>;">
        <h4>üëë Admin Controls</h4>
        <button id="btnEditRoom" class="btn-admin-small btn-edit-room">‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á</button>
      </div>
    </div>
  </div>
</div>

<%- contentFor('footer') %>
<!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ footer ‡∏û‡∏¥‡πÄ‡∏®‡∏© -->

<%- contentFor('script') %>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(function () {
    const socket = io();
    const playerId = '<%= player.playerId %>';
    const roomId = '<%= room.roomId %>';
    let isAdmin = <%= room.isAdmin ? 'true' : 'false' %>;
    
    // ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage =====
    function getGameSettings() {
        return JSON.parse(localStorage.getItem('gameSettings') || '{}');
    }
    
    function shouldConfirmLeave() {
        const settings = getGameSettings();
        return settings.confirmLeave !== false; // default ‡πÄ‡∏õ‡πá‡∏ô true
    }
    
    // ===== ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö / ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ =====
    let allowNavigation = false; // flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ navigate ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à
    let isShowingConfirm = false; // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á popup ‡∏≠‡∏¢‡∏π‡πà
    
    // ===== ‡∏ß‡∏¥‡∏ò‡∏µ Hash-based + Multiple History Entries (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô back ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) =====
    // ‡πÉ‡∏™‡πà history entries ‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏≠‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î back ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    function setupBackBlocker() {
        // ‡∏•‡∏ö hash ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÉ‡∏´‡∏°‡πà
        history.replaceState({ page: 'room', index: 0 }, '', location.pathname + location.search);
        // ‡πÉ‡∏™‡πà blocker entries ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô
        for (let i = 1; i <= 3; i++) {
            history.pushState({ page: 'room', index: i }, '', location.pathname + location.search + '#inroom');
        }
    }
    setupBackBlocker();
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
    function leaveRoomAndRedirect() {
        allowNavigation = true;
        socket.emit('leaveRoom', { roomId: roomId, playerId: playerId });
        setTimeout(() => {
            window.location.href = '/rooms?playerId=' + playerId;
        }, 150);
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á confirm dialog
    function showLeaveConfirmation() {
        if (isShowingConfirm) return;
        isShowingConfirm = true;
        
        // ‡πÉ‡∏™‡πà hash ‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á popup
        history.pushState(null, '', location.pathname + location.search + '#inroom');
        
        Swal.fire({
            icon: 'warning',
            title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠?',
            text: '‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ',
            showCancelButton: true,
            confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á',
            cancelButtonText: '‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠',
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#3085d6',
            background: '#1e1e1e',
            color: '#fff',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then((result) => {
            isShowingConfirm = false;
            if (result.isConfirmed) {
                leaveRoomAndRedirect();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚Üí ‡πÉ‡∏™‡πà blocker ‡∏Å‡∏•‡∏±‡∏ö
                setupBackBlocker();
            }
        });
    }
    
    // 1. ‡∏î‡∏±‡∏Å popstate (‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏Å‡∏î back)
    window.addEventListener('popstate', function(e) {
        if (allowNavigation) return;
        
        // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£ back ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡πÉ‡∏™‡πà history ‡∏Å‡∏•‡∏±‡∏ö
        e.preventDefault();
        
        if (!shouldConfirmLeave()) {
            leaveRoomAndRedirect();
            return;
        }
        
        if (!isShowingConfirm) {
            showLeaveConfirmation();
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á popup ‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡πÉ‡∏™‡πà blocker ‡∏Å‡∏•‡∏±‡∏ö
            setupBackBlocker();
        }
    });
    
    // 2. ‡∏î‡∏±‡∏Å hashchange (backup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á browser)
    window.addEventListener('hashchange', function(e) {
        if (allowNavigation) return;
        
        // ‡∏ñ‡πâ‡∏≤ hash ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (user ‡∏Å‡∏î back)
        if (!location.hash || location.hash !== '#inroom') {
            e.preventDefault();
            setupBackBlocker(); // ‡πÉ‡∏™‡πà blocker ‡∏Å‡∏•‡∏±‡∏ö
            
            if (!shouldConfirmLeave()) {
                leaveRoomAndRedirect();
                return;
            }
            
            if (!isShowingConfirm) {
                showLeaveConfirmation();
            }
        }
    });
    
    // 3. ‡∏î‡∏±‡∏Å beforeunload (‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏¥‡∏î tab/refresh)
    // ‡πÉ‡∏ä‡πâ sessionStorage flag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô refresh ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î tab ‡∏à‡∏£‡∏¥‡∏á
    sessionStorage.setItem('roomLobby_' + roomId, 'active');
    
    window.addEventListener('beforeunload', function(e) {
        if (allowNavigation) return;
        
        // ‡∏ï‡∏±‡πâ‡∏á flag ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞ unload - ‡∏ñ‡πâ‡∏≤ reload ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ flag ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
        sessionStorage.setItem('roomLobby_unloading_' + roomId, Date.now().toString());
        
        if (!shouldConfirmLeave()) {
            // ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á leaveRoom ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô beforeunload
            // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ server ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ disconnect timeout ‡πÅ‡∏ó‡∏ô
            return;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á dialog ‡∏Ç‡∏≠‡∏á browser (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á leaveRoom)
        e.preventDefault();
        e.returnValue = '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠?';
        return e.returnValue;
    });
    
    // 4. ‡∏î‡∏±‡∏Å pagehide (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile browsers - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß)
    window.addEventListener('pagehide', function(e) {
        // ‡∏ñ‡πâ‡∏≤ allowNavigation = true ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á leave
        if (allowNavigation) return;
        
        // e.persisted = true ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏π‡∏Å cache ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô bfcache (back/forward)
        // ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á leaveRoom ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ
        if (e.persisted) return;
        
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile: ‡∏™‡πà‡∏á leaveRoom ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà refresh)
        // ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á - pagehide ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å fire ‡∏ï‡∏≠‡∏ô refresh ‡∏î‡πâ‡∏ß‡∏¢
        // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ server disconnect timeout ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô
        // ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á sendBeacon ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    });
    
    // 5. ‡∏î‡∏±‡∏Å visibilitychange (‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏™‡∏•‡∏±‡∏ö tab ‡∏´‡∏£‡∏∑‡∏≠ minimize)
    let wasHidden = false;
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            wasHidden = true;
            // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô
            sessionStorage.setItem('hiddenTime', Date.now().toString());
        } else if (wasHidden) {
            // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
            wasHidden = false;
            socket.emit('checkRoomStatus', { roomId: roomId, playerId: playerId });
        }
    });
    
    // Function to show/hide admin controls
    function updateAdminUI() {
      if (isAdmin) {
        $('#btnStartGameLobby').show();
        $('#adminControlsSection').show();
      } else {
        $('#btnStartGameLobby').hide();
        $('#adminControlsSection').hide();
      }
      // Re-render player list ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô action icons ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      socket.emit('requestRoomUpdate', { roomId: roomId });
    }

    function updateStartButtonState(players) {
      const btn = $('#btnStartGameLobby');
      if (!btn.length) return;
      const count = players.length;
      if (count >= 3) {
        btn.prop('disabled', false);
        $('#lobbyStatusText').text('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°');
      } else {
        btn.prop('disabled', true);
        $('#lobbyStatusText').text('‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°');
      }
    }

    function renderPlayers(payload) {
      const players = payload.players || [];
      const adminId = payload.admin;
      $('#lobbyPlayerCount').text(payload.playerCount || players.length);
      $('#lobbyRoomLock').text(payload.locked ? 'üîí ‡∏•‡πá‡∏≠‡∏Ñ' : 'üîì ‡πÄ‡∏õ‡∏¥‡∏î');

      const $list = $('#lobbyPlayers');
      $list.empty();

      players.forEach(p => {
        const isAdminPlayer = p.playerId === adminId;
        const isSelf = p.playerId === playerId;
        const color = p.color || '#fff';
        const safeName = $('<div>').text(p.playerName).html();

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á action icons ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
        let actionIcons = '';
        if (isAdmin && !isSelf) {
          actionIcons = `
            <div class="player-action-icons">
              ${!isAdminPlayer ? `<button class="player-action-btn crown-btn" data-player-id="${p.playerId}" data-player-name="${safeName}" title="‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin">üëë</button>` : ''}
              <button class="player-action-btn kick-btn" data-player-id="${p.playerId}" data-player-name="${safeName}" title="‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">üö´</button>
            </div>
          `;
        }

        const $row = $(`
          <div class="lobby-player-item">
            <div class="lobby-player-main">
              <span class="lobby-player-avatar clickable-avatar" data-player-id="${p.playerId}" style="cursor:pointer; font-size:1.2em; margin-right:4px;" title="‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">${p.avatar || 'üë§'}</span>
              <span class="lobby-player-name" style="color:${color};">${safeName}</span>
              ${isAdminPlayer ? '<span class="lobby-player-admin-badge" style="margin-left:6px;">üëë</span>' : ''}
            </div>
            ${actionIcons}
          </div>
        `);
        $list.append($row);
      });

      updateStartButtonState(players);
    }

    // ===== Socket init =====
    socket.emit('initPlayer', playerId);
    socket.emit('setRoom', { roomId: roomId, playerId: playerId });

    socket.on('roomUpdate', function (payload) {
      // ‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å roomUpdate ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ roomId ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ socket.io ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
      if (!payload) return;
      console.log('[roomUpdate]', payload);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ admin ‡∏ñ‡πâ‡∏≤ payload ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• admin
      if (payload.admin) {
        const wasAdmin = isAdmin;
        isAdmin = payload.admin === playerId;
        // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        if (wasAdmin !== isAdmin) {
          if (isAdmin) {
            $('#btnStartGameLobby').show();
            $('#adminControlsSection').show();
          } else {
            $('#btnStartGameLobby').hide();
            $('#adminControlsSection').hide();
          }
        }
      }
      
      renderPlayers(payload);
    });

    // ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
    socket.on('kickedFromRoom', function(data) {
      allowNavigation = true; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      Swal.fire({
        icon: 'error',
        title: '‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á',
        text: data.message || '‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ',
        background: '#1e1e1e',
        color: '#fff',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        allowOutsideClick: false,
        allowEscapeKey: false
      }).then(() => {
        window.location.href = '/rooms?playerId=' + playerId;
      });
    });

    // ‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    socket.on('roomClosed', function(data) {
      allowNavigation = true;
      Swal.fire({
        icon: 'warning',
        title: '‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î',
        text: data.message || '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
        background: '#1e1e1e',
        color: '#fff',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        allowOutsideClick: false,
        allowEscapeKey: false
      }).then(() => {
        window.location.href = '/rooms?playerId=' + playerId;
      });
    });

    // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö/‡πÇ‡∏≠‡∏ô admin
    socket.on('adminTransferred', function(data) {
      console.log('[adminTransferred]', data, 'myPlayerId:', playerId);
      
      // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö admin ‡πÉ‡∏´‡∏°‡πà
      if (data.newAdminId === playerId) {
        Swal.fire({
          icon: 'success',
          title: 'üëë ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡πÅ‡∏•‡πâ‡∏ß!',
          text: '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß',
          background: '#1e1e1e',
          color: '#fff',
          timer: 3000,
          timerProgressBar: true,
          showConfirmButton: false
        });
        // Update local admin status
        isAdmin = true;
        console.log('[adminTransferred] Set isAdmin = true');
        // Show admin controls without reload
        $('#btnStartGameLobby').show();
        $('#adminControlsSection').show();
        // Re-request room update to re-render player list with admin icons
        // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ roomUpdate ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô
        setTimeout(function() {
          socket.emit('requestRoomUpdate', { roomId: roomId });
        }, 100);
      } else if (data.oldAdminId === playerId) {
        // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏°‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô admin ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏π‡∏Å‡πÇ‡∏≠‡∏ô
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'info',
          title: '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏ñ‡∏π‡∏Å‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
          background: '#1e1e1e',
          color: '#fff',
          timer: 2500,
          showConfirmButton: false
        });
        isAdmin = false;
        console.log('[adminTransferred] Set isAdmin = false');
        $('#btnStartGameLobby').hide();
        $('#adminControlsSection').hide();
        setTimeout(function() {
          socket.emit('requestRoomUpdate', { roomId: roomId });
        }, 100);
      } else {
        // ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload)
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'info',
          title: data.message || '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß',
          background: '#1e1e1e',
          color: '#fff',
          timer: 2500,
          showConfirmButton: false
        });
      }
    });

    // ===== Chat =====
    const myPlayerName = '<%= player.name %>';
    const myPlayerColor = '<%= playerInfo.color %>';
    
    // Sound notification function
    function soundNotify(type) {
      let audio;
      switch(type) {
        case 'popup':
          audio = new Audio('/static/sound/popup.mp3');
          break;
        default:
          audio = new Audio('/static/sound/popup.mp3');
      }
      audio.play().catch(e => { /* Browser may block autoplay */ });
    }
    
    function appendChatMessage(data) {
      const $area = $('#lobbyChatMessages');
      const safeName = $('<div>').text(data.playerName).html();
      const safeMsg = $('<div>').text(data.message).html();
      const timestamp = data.timestamp || '';
      const playerColor = data.color || '#fff';
      const avatar = data.avatar || 'üë§';
      const targetPlayerId = data.playerId || '';
      
      // Determine message type
      let msgClass = 'other-msg';
      if (data.playerName === 'System') {
        msgClass = 'system-msg';
      } else if (data.playerName === myPlayerName) {
        msgClass = 'my-msg';
      }
      
      let $msg;
      if (msgClass === 'system-msg') {
        // System message - centered
        $msg = $(`
          <div class="chat-msg ${msgClass}">
            <div class="chat-msg-bubble">
              <div class="chat-msg-text">üîî ${safeMsg}</div>
            </div>
            <div class="chat-msg-meta">${timestamp}</div>
          </div>
        `);
      } else {
        // Player message - with avatar
        $msg = $(`
          <div class="chat-msg ${msgClass}">
            <div class="chat-avatar clickable-avatar" data-player-id="${targetPlayerId}" style="background: ${playerColor}20; border-color: ${playerColor};" title="‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ${safeName}">${avatar}</div>
            <div class="chat-content">
              <div class="chat-msg-bubble" style="border-left: 3px solid ${playerColor};">
                <div class="chat-msg-name clickable-avatar" data-player-id="${targetPlayerId}" style="color:${playerColor};">${safeName}</div>
                <div class="chat-msg-text">${safeMsg}</div>
              </div>
              <div class="chat-msg-meta">${timestamp}</div>
            </div>
          </div>
        `);
      }
      
      $area.append($msg);
      $area[0].scrollTop = $area[0].scrollHeight;
    }

    $('#btnSendLobbyChat').on('click', function () {
      const $input = $('#lobbyChatInput');
      const msg = $input.val().trim();
      if (!msg) return;
      socket.emit('sendMessage', {
        message: msg,
        playerName: '<%= player.name %>'
      });
      $input.val('');
    });

    $('#lobbyChatInput').on('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        $('#btnSendLobbyChat').click();
      }
    });

    socket.on('newMessage', function (data) {
      appendChatMessage(data);
      // Play notification sound if message is not from me
      if (data.playerName !== myPlayerName) {
        soundNotify('popup');
      }
    });

    // ‡∏£‡∏±‡∏ö broadcast ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Admin)
    socket.on('systemBroadcast', function(data) {
      Swal.fire({
        icon: 'info',
        title: 'üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        text: data.message,
        background: '#1e1e1e',
        color: '#fff',
        confirmButtonColor: '#e74c3c'
      });
      // Also show in chat
      appendChatMessage({
        playerName: 'System',
        message: 'üì¢ ' + data.message,
        timestamp: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })
      });
    });

    // ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô
    socket.on('banned', function(data) {
      allowNavigation = true; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      Swal.fire({
        icon: 'error',
        title: 'üö´ ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô!',
        html: `<p><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${data.reason}</p><p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${data.durationHours === null ? '‡∏ñ‡∏≤‡∏ß‡∏£' : data.durationHours + ' ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á'}</p>`,
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        background: '#1e1e1e',
        color: '#fff',
        allowOutsideClick: false
      }).then(() => {
        window.location.href = '/banned?playerId=' + playerId;
      });
    });

    // ===== Admin actions =====
    if (isAdmin) {
      // Kick player via icon
      $(document).on('click', '.kick-btn', function () {
        const target = $(this).data('player-id');
        const playerName = $(this).data('player-name');
        
        Swal.fire({
          icon: 'warning',
          title: '‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',
          text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞ ${playerName} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
          background: '#1e1e1e',
          color: '#fff',
          showCancelButton: true,
          confirmButtonColor: '#e74c3c',
          cancelButtonColor: '#555',
          confirmButtonText: '‡πÄ‡∏ï‡∏∞',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
          if (result.isConfirmed) {
            socket.emit('kickPlayer', { targetPlayerId: target }, function (res) {
              if (!res || !res.success) {
                Swal.fire({
                  icon: 'error',
                  title: '‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                  text: res && res.error ? res.error : '',
                  background: '#1e1e1e',
                  color: '#fff'
                });
              }
            });
          }
        });
      });

      // Transfer admin via icon
      $(document).on('click', '.crown-btn', function () {
        const target = $(this).data('player-id');
        const playerName = $(this).data('player-name');
        
        Swal.fire({
          icon: 'question',
          title: '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin',
          text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ ${playerName} ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
          background: '#1e1e1e',
          color: '#fff',
          showCancelButton: true,
          confirmButtonColor: '#f39c12',
          cancelButtonColor: '#555',
          confirmButtonText: '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
          if (result.isConfirmed) {
            socket.emit('transferAdmin', { newAdminPlayerId: target }, function (res) {
              if (!res || !res.success) {
                Swal.fire({
                  icon: 'error',
                  title: '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                  text: res && res.error ? res.error : '',
                  background: '#1e1e1e',
                  color: '#fff'
                });
              }
              // Success handled by adminTransferred event
            });
          }
        });
      });

      $('#btnEditRoom').on('click', function () {
        const currentMaxPlayers = <%= room.maxPlayers %>;
        const currentRoundTime = <%= room.roundTime %>;
        const currentLocked = <%= room.locked ? 'true' : 'false' %>;
        const currentPassword = '<%= room.password %>';
        
        Swal.fire({
          title: '‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á',
          customClass: {
            popup: 'room-popup',
            confirmButton: 'room-btn-confirm',
            cancelButton: 'room-btn-cancel'
          },
          html: `
            <div style="font-family: 'Rajdhani', sans-serif;">
              <div class="room-form-group">
                <label class="room-form-label">
                  <span class="icon">üìù</span> ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á:
                </label>
                <input id="editRoomName" class="room-form-input" value="<%= room.name %>" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." maxlength="20">
              </div>
              
              <div class="room-form-group">
                <label class="room-form-label">
                  <span class="icon">üë•</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:
                </label>
                <div class="room-slider-container">
                  <span class="room-slider-value" id="editMaxPlayersValue">${currentMaxPlayers}</span>
                  <input type="range" id="editMaxPlayers" class="room-slider" min="3" max="10" value="${currentMaxPlayers}">
                </div>
              </div>
              
              <div class="room-form-group">
                <label class="room-form-label">
                  <span class="icon">‚è±Ô∏è</span> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö:
                </label>
                <div class="room-slider-container">
                  <span class="room-slider-value" id="editRoundTimeValue">${currentRoundTime} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
                  <input type="range" id="editRoundTime" class="room-slider" min="1" max="10" value="${currentRoundTime}">
                </div>
              </div>
              
              <div class="room-form-group">
                <label class="room-form-label">
                  <span class="icon">üîê</span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢:
                </label>
                <div class="room-checkbox-container ${currentLocked ? 'checked' : ''}" id="editLockedContainer">
                  <input type="checkbox" id="editLocked" class="room-checkbox" ${currentLocked ? 'checked' : ''}>
                  <div class="room-checkbox-custom">‚úì</div>
                  <span class="room-checkbox-text">üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)</span>
                </div>
              </div>
              
              <div class="room-form-group" id="editPasswordGroup" style="display: ${currentLocked ? 'block' : 'none'};">
                <label class="room-form-label">
                  <span class="icon">üîë</span> ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:
                </label>
                <input id="editPassword" class="room-form-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å" maxlength="4" pattern="[0-9]*" inputmode="numeric" value="${currentPassword}">
              </div>
            </div>
          `,
          background: 'transparent',
          showCancelButton: true,
          confirmButtonText: '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
          cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          focusConfirm: false,
          didOpen: () => {
            // Slider handlers
            const maxPlayersSlider = document.getElementById('editMaxPlayers');
            const maxPlayersValue = document.getElementById('editMaxPlayersValue');
            const roundTimeSlider = document.getElementById('editRoundTime');
            const roundTimeValue = document.getElementById('editRoundTimeValue');
            
            maxPlayersSlider.addEventListener('input', function() {
              maxPlayersValue.textContent = this.value;
              updateSliderBackground(this);
            });
            
            roundTimeSlider.addEventListener('input', function() {
              roundTimeValue.textContent = this.value + ' ‡∏ô‡∏≤‡∏ó‡∏µ';
              updateSliderBackground(this);
            });
            
            function updateSliderBackground(slider) {
              const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
              slider.style.background = `linear-gradient(90deg, #e74c3c 0%, #e74c3c ${percent}%, #333 ${percent}%, #333 100%)`;
            }
            
            updateSliderBackground(maxPlayersSlider);
            updateSliderBackground(roundTimeSlider);
            
            // Lock checkbox handler
            const lockedContainer = document.getElementById('editLockedContainer');
            const lockedCheckbox = document.getElementById('editLocked');
            const passwordGroup = document.getElementById('editPasswordGroup');
            
            lockedContainer.addEventListener('click', function() {
              lockedCheckbox.checked = !lockedCheckbox.checked;
              this.classList.toggle('checked', lockedCheckbox.checked);
              passwordGroup.style.display = lockedCheckbox.checked ? 'block' : 'none';
              if (!lockedCheckbox.checked) {
                document.getElementById('editPassword').value = '';
              }
            });
          },
          preConfirm: () => {
            const name = document.getElementById('editRoomName').value.trim();
            const maxPlayers = parseInt(document.getElementById('editMaxPlayers').value, 10);
            const roundTime = parseInt(document.getElementById('editRoundTime').value, 10);
            const locked = document.getElementById('editLocked').checked;
            const password = document.getElementById('editPassword').value.trim();
            
            if (!name) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á');
              return false;
            }
            
            if (locked && (!password || !/^\d{4}$/.test(password))) {
              Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)');
              return false;
            }
            
            return {
              name,
              maxPlayers,
              roundTime,
              locked,
              password: locked ? password : ''
            };
          }
        }).then(result => {
          if (result.isConfirmed && result.value) {
            socket.emit('updateRoom', result.value, function (res) {
              if (!res || !res.success) {
                Swal.fire({
                  icon: 'error',
                  title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                  text: res && res.error ? res.error : '',
                  background: '#1e1e1e',
                  color: '#fff'
                });
              } else {
                Swal.fire({
                  icon: 'success',
                  title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                  background: '#1e1e1e',
                  color: '#fff',
                  timer: 1500,
                  showConfirmButton: false
                }).then(() => {
                  window.location.reload();
                });
              }
            });
          }
        });
      });

      $('#btnStartGameLobby').on('click', function () {
        const btn = $(this);
        if (btn.data('loading')) return;
        btn.data('loading', true);
        btn.text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...');
        socket.emit('startGameFromLobby', { roomId: roomId }, function(res) {
          btn.data('loading', false);
          if (!res || !res.success) {
            btn.text('üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°');
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: res && res.error ? res.error : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              background: '#1e1e1e',
              color: '#fff'
            });
          }
          // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á redirect ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏£‡∏≠‡πÉ‡∏´‡πâ server ‡∏™‡πà‡∏á event 'gameStarting' ‡πÅ‡∏ó‡∏ô
        });
      });
    }

    // ‡∏£‡∏±‡∏ö event countdown ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô sync)
    socket.on('gameStartingCountdown', function(data) {
      console.log('[gameStartingCountdown] Game starting in', data.countdown, 'seconds');
      let countdown = data.countdown;
      
      Swal.fire({
        icon: 'info',
        title: 'üéÆ ‡πÄ‡∏Å‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°!',
        html: '<div style="font-size: 3em; font-weight: bold;" id="startCountdown">' + countdown + '</div>',
        showConfirmButton: false,
        allowOutsideClick: false,
        background: '#1e1e1e',
        color: '#fff'
      });
      
      const countdownInterval = setInterval(() => {
        countdown--;
        const el = document.getElementById('startCountdown');
        if (el) el.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(countdownInterval);
        }
      }, 1000);
    });
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö)
    socket.on('gameStartCancelled', function(data) {
      console.log('[gameStartCancelled]', data.error);
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        background: '#1e1e1e',
        color: '#fff'
      });
    });

    // ‡∏£‡∏±‡∏ö event ‡∏à‡∏≤‡∏Å server ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Üí redirect ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    socket.on('gameStarting', function(data) {
      console.log('[gameStarting] Redirecting to game...');
      Swal.fire({
        icon: 'success',
        title: '‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!',
        text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°...',
        timer: 1000,
        showConfirmButton: false,
        background: '#1e1e1e',
        color: '#fff'
      }).then(() => {
        allowNavigation = true; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï navigate ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°
        window.location.href = `/game/${data.roomId}?playerId=${playerId}`;
      });
      // Fallback redirect
      setTimeout(() => {
        allowNavigation = true;
        window.location.href = `/game/${data.roomId}?playerId=${playerId}`;
      }, 1100);
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á - emit leaveRoom ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠ callback ‡∏Å‡πà‡∏≠‡∏ô redirect
    $('#btnLeaveRoom').on('click', function() {
      Swal.fire({
        icon: 'question',
        title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        background: '#1e1e1e',
        color: '#fff',
        showCancelButton: true,
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#555',
        confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then((result) => {
        if (result.isConfirmed) {
          // ‡πÅ‡∏™‡∏î‡∏á loading
          Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á...',
            allowOutsideClick: false,
            showConfirmButton: false,
            background: '#1e1e1e',
            color: '#fff',
            didOpen: () => { Swal.showLoading(); }
          });
          
          // emit leaveRoom ‡∏û‡∏£‡πâ‡∏≠‡∏° callback
          socket.emit('leaveRoom', {}, function(response) {
            allowNavigation = true;
            window.location.href = '/rooms?playerId=' + playerId;
          });
          
          // Fallback: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö callback ‡πÉ‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ redirect ‡πÄ‡∏•‡∏¢
          setTimeout(function() {
            allowNavigation = true;
            window.location.href = '/rooms?playerId=' + playerId;
          }, 2000);
        }
      });
    });

    // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô room ‡∏£‡∏±‡∏ö event ‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°
    socket.on('gameStarted', function (data) {
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ board.ejs
      allowNavigation = true;
      window.location.href = '/game/' + roomId + '?playerId=' + playerId;
    });
    
    // Frame styles lookup
    const frameStyles = {
      'none': 'none',
      'bronze': 'linear-gradient(135deg, #cd7f32 0%, #8b4513 100%)',
      'silver': 'linear-gradient(135deg, #c0c0c0 0%, #808080 100%)',
      'gold': 'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)',
      'diamond': 'linear-gradient(135deg, #b9f2ff 0%, #00bfff 100%)',
      'fire': 'linear-gradient(135deg, #ff4500 0%, #ff0000 100%)',
      'rainbow': 'linear-gradient(135deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff)',
      'neon': 'linear-gradient(135deg, #00ff00 0%, #00ffff 50%, #ff00ff 100%)'
    };
    
    // Click on avatar to view profile
    $(document).on('click', '.clickable-avatar', function() {
      const targetPlayerId = $(this).data('player-id');
      showPlayerProfile(targetPlayerId);
    });
    
    // Show player profile modal
    function showPlayerProfile(targetPlayerId) {
      $.get('/api/player/' + targetPlayerId + '/profile', function(data) {
        const frameStyle = frameStyles[data.avatarFrame] || 'none';
        const joinedDate = new Date(data.createdAt).toLocaleDateString('th-TH');
        const lastPlayed = data.stats?.lastPlayedAt ? new Date(data.stats.lastPlayedAt).toLocaleDateString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡πà‡∏ô';
        
        const stats = data.stats || { totalGames: 0, wins: 0, losses: 0, winRate: 0, roleStats: { gameMasterCount: 0, traitorCount: 0, citizenCount: 0 }, winByRole: { winAsTraitor: 0, winAsCitizen: 0 } };
        
        const html = `
          <div class="profile-modal-content">
            <div class="profile-modal-header">
              <div class="profile-modal-avatar">
                <div class="profile-modal-avatar-inner" style="background: ${data.color}20; border-color: ${data.color};">
                  ${data.avatar}
                </div>
                ${frameStyle !== 'none' ? '<div class="profile-modal-avatar-frame" style="background: ' + frameStyle + ';"></div>' : ''}
              </div>
              <div>
                <h2 class="profile-modal-name" style="color: ${data.color};">${$('<div>').text(data.playerName).html()}</h2>
                <p class="profile-modal-joined">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${joinedDate}</p>
              </div>
            </div>
            
            <div class="profile-modal-stats">
              <div class="profile-stat-box">
                <div class="profile-stat-value" style="color: #3498db;">${stats.totalGames}</div>
                <div class="profile-stat-label">‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</div>
              </div>
              <div class="profile-stat-box">
                <div class="profile-stat-value" style="color: #2ecc71;">${stats.wins}</div>
                <div class="profile-stat-label">‡∏ä‡∏ô‡∏∞</div>
              </div>
              <div class="profile-stat-box">
                <div class="profile-stat-value" style="color: #f39c12;">${stats.winRate}%</div>
                <div class="profile-stat-label">Win Rate</div>
              </div>
            </div>
            
            <div class="profile-roles">
              <h4>üé≠ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</h4>
              <div class="profile-role-row">
                <span>üü¢ ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°</span>
                <span>${stats.roleStats.gameMasterCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
              </div>
              <div class="profile-role-row">
                <span>üî¥ ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®</span>
                <span>${stats.roleStats.traitorCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ä‡∏ô‡∏∞ ${stats.winByRole.winAsTraitor})</span>
              </div>
              <div class="profile-role-row">
                <span>üîµ ‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á</span>
                <span>${stats.roleStats.citizenCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ä‡∏ô‡∏∞ ${stats.winByRole.winAsCitizen})</span>
              </div>
              <div class="profile-role-row">
                <span>üïê ‡πÄ‡∏•‡πà‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                <span>${lastPlayed}</span>
              </div>
            </div>
          </div>
        `;
        
        Swal.fire({
          title: '',
          html: html,
          background: '#1a1a2e',
          color: '#fff',
          showConfirmButton: true,
          confirmButtonText: '‡∏õ‡∏¥‡∏î',
          confirmButtonColor: '#e74c3c',
          width: 400
        });
      }).fail(function() {
        Swal.fire({
          icon: 'error',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ',
          background: '#1e1e1e',
          color: '#fff',
          confirmButtonColor: '#e74c3c'
        });
      });
    }
  });
</script>

