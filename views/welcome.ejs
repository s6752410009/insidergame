<%- contentFor('content') %>
<h2>คุณคือใคร?</h2>
<span class="homelink">แก้ไขรายชื่อผู้เล่น, <a href="/adminPlayer">คลิกที่นี่</a> !</span>

<form class="inline-block" id="playerChoiceForm" method="post" name="playerForm" action="game">
    <% if (players.length === 0) { %>
        <p>ไม่มีผู้เล่นให้เลือก กรุณาสร้างผู้เล่นใหม่ในหน้า <a href="/adminPlayer">Admin Player</a></p>
    <% } else { %>
        <% players.forEach(function(player, index) { %>
            <div class="form__group">
                <div class="form__radio-group">
                    <input <% if(index == 0) { %>checked<% } %> type="radio" class="form__radio-input" id="<%= player.name %>" name="player" value="<%= player.name %>" />
                    <label for="<%= player.name %>" class="form__radio-label">
                        <%= player.name %>
                    </label>
                </div>
            </div>
        <% }); %>
    <% } %>
</form>

<%- contentFor('footer') %> 
<div class="container">
  <button class="btn btn-dark cta" id="newGame" <% if (players.length === 0) { %>disabled<% } %>>เริ่มเกม</button>
</div>

<%- contentFor('script') %>
<script>
$(function() {
    // หากมี socket อยู่แล้ว ให้ใช้ตัวนั้น ถ้ายังไม่มี ให้สร้างใหม่
    var socketForWelcome;
    try {
        socketForWelcome = io();
    } catch (e) {
        console.warn('Socket.IO client not available for welcome page.', e);
        socketForWelcome = null;
    }

    function renderAvailablePlayers(list) {
        var $form = $('#playerChoiceForm');
        $form.empty();

        if (!list || list.length === 0) {
            $form.append('<p>ไม่มีผู้เล่นให้เลือก กรุณาสร้างผู้เล่นใหม่ในหน้า <a href="/adminPlayer">Admin Player</a></p>');
            $('#newGame').attr('disabled', true);
            return;
        }

        // สร้าง radio inputs
        list.forEach(function(player, index) {
            var checked = index === 0 ? 'checked' : '';
            var html = '<div class="form__group">'
                     + '<div class="form__radio-group">'
                     + '<input ' + checked + ' type="radio" class="form__radio-input" id="' + escapeHtml(player.name) + '" name="player" value="' + escapeHtml(player.name) + '" />'
                     + '<label for="' + escapeHtml(player.name) + '" class="form__radio-label">' + escapeHtml(player.name) + '</label>'
                     + '</div></div>';
            $form.append(html);
        });

        $('#newGame').attr('disabled', false);
    }

    function escapeHtml(str) {
        return String(str).replace(/[&<>"'`=\/]/g, function(s) {
            return ({
                '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'
            })[s];
        });
    }

    // ถ้าสร้าง socket สำเร็จ ให้ฟัง event
    if (socketForWelcome) {
        socketForWelcome.on('availablePlayersUpdate', function(availablePlayers) {
            // availablePlayers: [{ name: 'ผู้เล่น 1', permission: ... }, ...]
            renderAvailablePlayers(availablePlayers);
        });

        // ขอรายการเริ่มต้น (ถ้าระบบเซิฟเวอร์ส่งให้เฉพาะเมื่อมีการเปลี่ยนแปลง)
        socketForWelcome.emit('requestAvailablePlayers'); // *ถ้าเซิฟเวอร์ไม่ได้รองรับ event นี้ มันจะไม่มีผล ไม่เป็นไร*
    }

    // keep existing start-button behavior
    $("#newGame").off('click').on('click', function(){
        // ถ้าไม่มี input ให้เลือกจะไม่ submit
        if ($('#playerChoiceForm input[name="player"]').length === 0) return;
        $('.content form').submit();
    });
});
</script>