<%- contentFor('content') %>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    .profile-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
        font-family: 'Rajdhani', sans-serif;
    }
    
    .profile-container h1 {
        margin-bottom: 40px;
        color: #fff;
        font-family: 'Orbitron', sans-serif;
        font-weight: 900;
        font-size: 2.8em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        letter-spacing: 2px;
        text-align: center;
    }
    
    .profile-section {
        background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
        border: 3px solid #444;
        border-radius: 15px;
        padding: 35px;
        margin-bottom: 30px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    
    .profile-section h2 {
        color: #fff;
        font-family: 'Orbitron', sans-serif;
        font-weight: 700;
        font-size: 1.8em;
        margin-bottom: 25px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        border-bottom: 2px solid #e74c3c;
        padding-bottom: 10px;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #fff;
        font-size: 1.1em;
        font-family: 'Rajdhani', sans-serif;
    }
    
    #playerNameInput {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #444;
        border-radius: 8px;
        background: #1a1a1a;
        color: #fff;
        font-family: 'Rajdhani', sans-serif;
        font-size: 1em;
    }
    
    #playerNameInput:focus {
        outline: none;
        border-color: #e74c3c;
        box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
    }
    
    .btn-profile {
        padding: 12px 24px;
        border: 2px solid #e74c3c;
        border-radius: 8px;
        background: #e74c3c;
        color: #fff;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
    }
    
    .btn-profile:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }
    
    .color-btn {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        border: 3px solid transparent;
    }
    
    .color-btn:hover {
        transform: scale(1.15);
        box-shadow: 0 4px 12px rgba(255,255,255,0.3);
    }
    
    .color-btn.active {
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255,255,255,0.5);
    }
    
    .player-id {
        margin-top: 25px;
        padding: 20px;
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 8px;
    }
    
    .player-id p {
        margin: 0;
        color: #aaa;
        font-size: 0.95em;
        font-family: 'Rajdhani', sans-serif;
    }
    
    .player-id code {
        background: #2d2d2d;
        padding: 4px 10px;
        border-radius: 5px;
        color: #ff6b6b;
        font-family: 'Courier New', monospace;
        border: 1px solid #444;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 35px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        border: 3px solid #444;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        border-color: #e74c3c;
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
    }
    
    .stat-icon {
        font-size: 2.5em;
        margin-bottom: 10px;
        display: block;
    }
    
    .stat-value {
        font-size: 3em;
        font-weight: 900;
        color: #fff;
        font-family: 'Orbitron', sans-serif;
        margin: 10px 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .stat-label {
        color: #aaa;
        font-size: 1.1em;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        margin-top: 8px;
    }
    
    .stats-section-title {
        color: #fff;
        font-family: 'Orbitron', sans-serif;
        font-weight: 700;
        font-size: 1.5em;
        margin-top: 35px;
        margin-bottom: 20px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
    }
    
    .role-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 18px;
        margin-bottom: 30px;
    }
    
    .role-stat-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        border: 3px solid #444;
        border-left: 5px solid;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
    }
    
    .role-stat-card:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    
    .role-stat-card.citizen {
        border-left-color: #3498db;
    }
    
    .role-stat-card.traitor {
        border-left-color: #e74c3c;
    }
    
    .role-stat-card.gamemaster {
        border-left-color: #f39c12;
    }
    
    .role-stat-icon {
        font-size: 2em;
        margin-bottom: 8px;
    }
    
    .role-stat-value {
        font-size: 2.2em;
        font-weight: 900;
        color: #fff;
        font-family: 'Orbitron', sans-serif;
        margin: 8px 0;
    }
    
    .role-stat-label {
        color: #aaa;
        font-size: 1em;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
    }
    
    .empty-stats {
        text-align: center;
        padding: 60px 40px;
        color: #aaa;
    }
    
    .empty-stats p {
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.3em;
        margin: 10px 0;
    }
    
    .empty-stats p:first-child {
        font-size: 1.6em;
        color: #fff;
        font-weight: 600;
    }
    
    .last-played {
        margin-top: 30px;
        padding: 20px;
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 8px;
    }
    
    .last-played p {
        margin: 0;
        color: #aaa;
        font-family: 'Rajdhani', sans-serif;
        font-size: 1em;
    }
    
    .last-played strong {
        color: #fff;
    }
    
    /* SweetAlert2 Dark Theme */
    .swal2-popup {
        background: #1e1e1e !important;
        color: #fff !important;
        font-family: 'Rajdhani', sans-serif !important;
    }
    
    .swal2-title {
        color: #fff !important;
        font-family: 'Orbitron', sans-serif !important;
        font-weight: 700 !important;
    }
    
    .swal2-content {
        color: #ddd !important;
    }
    
    .swal2-confirm {
        background: #e74c3c !important;
        border-color: #c0392b !important;
        font-family: 'Rajdhani', sans-serif !important;
        font-weight: 600 !important;
    }
    
    .swal2-confirm:hover {
        background: #c0392b !important;
    }
    
    /* Avatar Selection */
    .avatar-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .avatar-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #1a1a1a;
        border: 3px solid #444;
        font-size: 1.8em;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .avatar-btn:hover {
        transform: scale(1.15);
        border-color: #e74c3c;
    }
    
    .avatar-btn.active {
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255,255,255,0.5);
        background: #333;
    }
    
    /* Frame Selection */
    .frame-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .frame-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: #1a1a1a;
        border: 4px solid #444;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .frame-btn:hover {
        transform: scale(1.1);
    }
    
    .frame-btn.active {
        border-color: #fff;
        box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    
    .frame-btn .frame-preview {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
    }
    
    .frame-btn .frame-name {
        position: absolute;
        bottom: -22px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.7em;
        color: #888;
        white-space: nowrap;
    }
    
    .avatar-preview-box {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
        padding: 20px;
        background: #1a1a1a;
        border-radius: 12px;
        border: 2px solid #444;
    }
    
    .avatar-preview {
        position: relative;
        width: 90px;
        height: 90px;
    }
    
    .avatar-preview-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5em;
        border: 4px solid;
        background: rgba(255,255,255,0.05);
        position: relative;
        z-index: 2;
    }
    
    .avatar-preview-frame {
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border-radius: 50%;
        z-index: 1;
    }
    
    .avatar-preview-info h3 {
        margin: 0 0 5px 0;
        font-family: 'Orbitron', sans-serif;
    }
    
    .avatar-preview-info p {
        margin: 0;
        color: #888;
        font-size: 0.9em;
    }
</style>

<div class="profile-container">
    <h1>üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h1>
    
    <div class="profile-section">
        <h2>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
        
        <div class="form-group">
            <label>‚úèÔ∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
            <div style="display: flex; gap: 12px;">
                <input type="text" id="playerNameInput" value="<%= player.playerName %>">
                <button id="updateNameBtn" class="btn-profile">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <div class="form-group">
            <label>üé® ‡∏™‡∏µ‡∏ä‡∏∑‡πà‡∏≠:</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <% availableColors.forEach(function(color) { %>
                    <button class="color-btn <%= color === player.color ? 'active' : '' %>" 
                            data-color="<%= color %>"
                            style="background: <%= color %>;">
                    </button>
                <% }); %>
            </div>
            <p style="margin-top: 15px; color: #aaa; font-size: 1em;">‡∏™‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong style="color: <%= player.color %>; font-size: 1.1em;"><%= player.playerName %></strong></p>
        </div>

        <div class="player-id">
            <p style="margin-bottom: 5px;">
                <strong>üÜî Player ID:</strong>
            </p>
            <p>
                <code style="display: block; word-break: break-all; font-size: 0.95em;"><%= player.playerId %></code>
            </p>
        </div>
    </div>
    
    <!-- Avatar Customization Section -->
    <div class="profile-section">
        <h2>üé≠ ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
        
        <!-- Preview -->
        <div class="avatar-preview-box">
            <div class="avatar-preview">
                <div class="avatar-preview-inner" id="avatarPreviewInner" style="border-color: <%= player.color %>;">
                    <%= player.avatar || 'üë§' %>
                </div>
                <div class="avatar-preview-frame" id="avatarPreviewFrame"></div>
            </div>
            <div class="avatar-preview-info">
                <h3 style="color: <%= player.color %>;"><%= player.playerName %></h3>
                <p>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</p>
            </div>
        </div>
        
        <div class="form-group">
            <label>üòÄ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Avatar:</label>
            <div class="avatar-selection" id="avatarSelection">
                <!-- Loaded by JS -->
            </div>
        </div>
        
        <div class="form-group" style="margin-top: 30px;">
            <label>‚ú® ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö:</label>
            <div class="frame-selection" id="frameSelection">
                <!-- Loaded by JS -->
            </div>
        </div>
    </div>

    <div class="stats-section">
        <h2>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
        
        <%
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô
            const displayStats = stats || {
                totalGames: 0,
                wins: 0,
                losses: 0,
                roleStats: {
                    gameMasterCount: 0,
                    traitorCount: 0,
                    citizenCount: 0
                },
                winByRole: {
                    winAsTraitor: 0,
                    winAsCitizen: 0
                },
                lastPlayedAt: null
            };
            const winRate = displayStats.totalGames > 0 ? Math.round((displayStats.wins / displayStats.totalGames) * 100) : 0;
        %>
        
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-icon">üéÆ</span>
                <div class="stat-value" style="color: #3498db;"><%= displayStats.totalGames %></div>
                <div class="stat-label">‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            
            <div class="stat-card">
                <span class="stat-icon">üèÜ</span>
                <div class="stat-value" style="color: #27ae60;"><%= displayStats.wins %></div>
                <div class="stat-label">‡∏ä‡∏ô‡∏∞</div>
            </div>
            
            <div class="stat-card">
                <span class="stat-icon">üíî</span>
                <div class="stat-value" style="color: #e74c3c;"><%= displayStats.losses %></div>
                <div class="stat-label">‡πÅ‡∏û‡πâ</div>
            </div>
            
            <div class="stat-card">
                <span class="stat-icon">üìà</span>
                <div class="stat-value" style="color: #f39c12;">
                    <%= winRate %>%
                </div>
                <div class="stat-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ä‡∏ô‡∏∞</div>
            </div>
        </div>

        <h3 class="stats-section-title">üé≠ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</h3>
        <div class="role-stats-grid">
            <div class="role-stat-card gamemaster">
                <div class="role-stat-icon">üëë</div>
                <div class="role-stat-value" style="color: #f39c12;"><%= displayStats.roleStats.gameMasterCount %></div>
                <div class="role-stat-label">‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°</div>
            </div>
            
            <div class="role-stat-card traitor">
                <div class="role-stat-icon">üòà</div>
                <div class="role-stat-value" style="color: #e74c3c;"><%= displayStats.roleStats.traitorCount %></div>
                <div class="role-stat-label">‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®</div>
            </div>
            
            <div class="role-stat-card citizen">
                <div class="role-stat-icon">üë§</div>
                <div class="role-stat-value" style="color: #3498db;"><%= displayStats.roleStats.citizenCount %></div>
                <div class="role-stat-label">‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á</div>
            </div>
        </div>

        <h3 class="stats-section-title">üéØ ‡∏ä‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</h3>
        <div class="role-stats-grid">
            <div class="role-stat-card traitor">
                <div class="role-stat-icon">üòà</div>
                <div class="role-stat-value" style="color: #e74c3c;"><%= displayStats.winByRole.winAsTraitor %></div>
                <div class="role-stat-label">‡∏ä‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®</div>
            </div>
            
            <div class="role-stat-card citizen">
                <div class="role-stat-icon">üë§</div>
                <div class="role-stat-value" style="color: #3498db;"><%= displayStats.winByRole.winAsCitizen %></div>
                <div class="role-stat-label">‡∏ä‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á</div>
            </div>
        </div>

        <div class="last-played">
            <p>
                <strong>üïê ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> 
                <% if (displayStats.lastPlayedAt) { %>
                    <%= new Date(displayStats.lastPlayedAt).toLocaleString('th-TH') %>
                <% } else { %>
                    <span style="color: #888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡πà‡∏ô</span>
                <% } %>
            </p>
        </div>
    </div>
</div>

<%- contentFor('footer') %>
<div class="container">
    <a href="/?playerId=<%= player.playerId %>" class="btn btn-dark" style="font-family: 'Rajdhani', sans-serif; font-weight: 600;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Lobby</a>
</div>

<%- contentFor('script') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(function() {
    const playerId = '<%= player.playerId %>';
    
    // Update name
    $('#updateNameBtn').on('click', function() {
        const newName = $('#playerNameInput').val().trim();
        if (!newName) {
            Swal.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠',
                text: '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ',
                background: '#1e1e1e',
                color: '#fff',
                confirmButtonColor: '#f39c12'
            });
            return;
        }

        $.ajax({
            url: '/profile/updateName?playerId=' + playerId,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: newName }),
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 2000,
                        showConfirmButton: false,
                        background: '#1e1e1e',
                        color: '#fff'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: response.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        background: '#1e1e1e',
                        color: '#fff',
                        confirmButtonColor: '#e74c3c'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ',
                    background: '#1e1e1e',
                    color: '#fff',
                    confirmButtonColor: '#e74c3c'
                });
            }
        });
    });

    // Update color
    $('.color-btn').on('click', function() {
        const color = $(this).data('color');
        
        $.ajax({
            url: '/profile/updateColor?playerId=' + playerId,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ color: color }),
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        timer: 1500,
                        showConfirmButton: false,
                        background: '#1e1e1e',
                        color: '#fff'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        text: response.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        background: '#1e1e1e',
                        color: '#fff',
                        confirmButtonColor: '#e74c3c'
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏î‡πâ',
                    background: '#1e1e1e',
                    color: '#fff',
                    confirmButtonColor: '#e74c3c'
                });
            }
        });
    });
    
    // Current values
    let currentAvatar = '<%= player.avatar || "üë§" %>';
    let currentFrame = '<%= player.avatarFrame || "none" %>';
    const playerColor = '<%= player.color %>';
    
    // Frame styles
    const frameStyles = {
        'none': 'none',
        'bronze': 'linear-gradient(135deg, #cd7f32 0%, #8b4513 100%)',
        'silver': 'linear-gradient(135deg, #c0c0c0 0%, #808080 100%)',
        'gold': 'linear-gradient(135deg, #ffd700 0%, #ff8c00 100%)',
        'diamond': 'linear-gradient(135deg, #b9f2ff 0%, #00bfff 100%)',
        'fire': 'linear-gradient(135deg, #ff4500 0%, #ff0000 100%)',
        'rainbow': 'linear-gradient(135deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff)',
        'neon': 'linear-gradient(135deg, #00ff00 0%, #00ffff 50%, #ff00ff 100%)'
    };
    
    // Load avatars and frames
    console.log('Loading avatars...');
    $.ajax({
        url: '/api/avatars',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log('Avatars API response:', data);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ data ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            var avatars = (data && Array.isArray(data.avatars)) ? data.avatars : [];
            var frames = (data && Array.isArray(data.frames)) ? data.frames : [];
            
            // Render avatars
            var $avatarContainer = $('#avatarSelection');
            $avatarContainer.empty();
            if (avatars.length > 0) {
                for (var i = 0; i < avatars.length; i++) {
                    var avatar = avatars[i];
                    var isActive = avatar === currentAvatar ? 'active' : '';
                    $avatarContainer.append('<button class="avatar-btn ' + isActive + '" data-avatar="' + avatar + '">' + avatar + '</button>');
                }
            } else {
                $avatarContainer.html('<p style="color:#aaa;">‡πÑ‡∏°‡πà‡∏û‡∏ö Avatar</p>');
            }
            
            // Render frames
            var $frameContainer = $('#frameSelection');
            $frameContainer.empty();
            if (frames.length > 0) {
                for (var j = 0; j < frames.length; j++) {
                    var frame = frames[j];
                    var frameActive = frame.id === currentFrame ? 'active' : '';
                    var bgStyle = frame.style !== 'none' ? 'background: ' + frame.style + ';' : 'background: #333;';
                    $frameContainer.append('<button class="frame-btn ' + frameActive + '" data-frame="' + frame.id + '"><div class="frame-preview" style="' + bgStyle + '">üë§</div><span class="frame-name">' + frame.name + '</span></button>');
                }
            } else {
                $frameContainer.html('<p style="color:#aaa;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏£‡∏≠‡∏ö Avatar</p>');
            }
            
            // Update preview frame
            updateFramePreview();
        },
        error: function(xhr, status, error) {
            console.error('Failed to load avatars:', error);
            $('#avatarSelection').html('<p style="color:#f00;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error + '</p>');
            $('#frameSelection').html('<p style="color:#f00;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>');
        }
    });
    
    // Update preview
    function updateFramePreview() {
        const frameStyle = frameStyles[currentFrame];
        if (frameStyle && frameStyle !== 'none') {
            $('#avatarPreviewFrame').css('background', frameStyle).show();
        } else {
            $('#avatarPreviewFrame').hide();
        }
        $('#avatarPreviewInner').text(currentAvatar);
    }
    
    // Avatar click
    $(document).on('click', '.avatar-btn', function() {
        const avatar = $(this).data('avatar');
        
        $.ajax({
            url: '/profile/updateAvatar?playerId=' + playerId,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ avatar: avatar }),
            success: function(response) {
                if (response.success) {
                    currentAvatar = avatar;
                    $('.avatar-btn').removeClass('active');
                    $(`.avatar-btn[data-avatar="${avatar}"]`).addClass('active');
                    updateFramePreview();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Avatar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        timer: 1200,
                        showConfirmButton: false,
                        background: '#1e1e1e',
                        color: '#fff'
                    });
                }
            }
        });
    });
    
    // Frame click
    $(document).on('click', '.frame-btn', function() {
        const frameId = $(this).data('frame');
        
        $.ajax({
            url: '/profile/updateAvatarFrame?playerId=' + playerId,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ frameId: frameId }),
            success: function(response) {
                if (response.success) {
                    currentFrame = frameId;
                    $('.frame-btn').removeClass('active');
                    $(`.frame-btn[data-frame="${frameId}"]`).addClass('active');
                    updateFramePreview();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        timer: 1200,
                        showConfirmButton: false,
                        background: '#1e1e1e',
                        color: '#fff'
                    });
                }
            }
        });
    });
});
</script>
