<%- contentFor('content') %>
<div class="player">
    <div class="playerStatus"></div>
    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß <strong style="color: <%= playerInfo.color %>;"><%= player.name %></strong> !
</div>
<!-- Room Info - ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î -->
<div style="text-align: center; margin-top: 5px; margin-bottom: 10px;">
    <div style="padding: 12px 20px; background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); border: 2px solid #444; border-radius: 10px; display: inline-block; color: #fff; font-family: 'Rajdhani', sans-serif;">
        <strong style="color: #f39c12;">üéÆ ‡∏´‡πâ‡∏≠‡∏á:</strong> <%= room.name %> (ID: <%= room.roomId %>) | 
        <strong style="color: #3498db;">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</strong> <%= room.playerCount %>/<%= room.maxPlayers %>
        <% if (room.admin) { %>
            | <span style="color: #e74c3c;">üëë Admin</span>
        <% } %>
    </div>
</div>
<!-- Connection Status Indicator -->
<div id="connectionStatus" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #f39c12; color: #000; padding: 8px 16px; border-radius: 20px; display: none; z-index: 10001; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">‡∏Å‡∏≥‡∏•‡∏±‡∏á reconnect...</div>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á -->
<button id="toggleSidebarBtn" class="btn btn-secondary">
    <i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
</button>

<!-- ‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå -->
<div id="playerSidebar">
    <div id="onlinePlayers">
        <h4>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á:</h4>
        <ul id="onlinePlayerList">
            <!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏£‡∏Å‡πÇ‡∏î‡∏¢ JavaScript -->
        </ul>
        <% if (room.admin) { %>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                <h5>Admin Controls</h5>
                <button id="updateRoomBtn" class="btn btn-sm btn-warning" style="width: 100%; margin-bottom: 5px;">‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á</button>
                <button id="transferAdminBtn" class="btn btn-sm btn-info" style="width: 100%; margin-bottom: 5px;">üëë ‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ Admin</button>
                <div id="kickPlayerSection" style="margin-top: 10px;">
                    <label style="font-size: 0.9em;">‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
                    <select id="kickPlayerSelect" class="form-control form-control-sm" style="margin-bottom: 5px;">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...</option>
                    </select>
                    <button id="kickPlayerBtn" class="btn btn-sm btn-danger" style="width: 100%;">üö´ ‡πÄ‡∏ï‡∏∞</button>
                </div>
            </div>
        <% } %>
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á - ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ -->
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #555;">
            <button id="leaveRoomBtn" class="btn btn-sm btn-outline-danger" style="width: 100%;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
        <button id="closeSidebarBtn" class="btn btn-sm btn-secondary mt-3">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>
<!-- Overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà -->
<div id="sidebarOverlay"></div>


<div id="waiting" class="hidden <% if (status === '') { %>current<% } %>">
    <p>‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° ...</p>
</div>

<div id="reset">
    <p class="role" style="display:<% if (status == 'role') { %>block<% } else { %>none<% } %>;">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ <strong><%= player.role %></strong></p>
</div>

<div id="chooseWord" class="hidden">
    <form id="wordForm" method="post" name="wordForm" action="setWord" autocomplete="off">
        <div class="form-group">
            <input type="text" name="word" class="form-control" id="wordInput" style="width: 60%; display: inline;" placeholder="‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏¢" />
            <button type="submit" class="btn btn-warning">‡∏™‡πà‡∏á</button>
            <small class="form-text">‡∏Å‡∏î‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏¥‡∏î‡πÉ‡∏´‡πâ</small>
        </div>
    </form>
</div>

<div id="reveal">
    <% if (player.role === '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°') { %>
        <button class="btn btn-warning cta hidden">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥</button>
    <% } %>
    <div id="word" class="hidden"></div>
</div>

<div id="startGame" class="hidden">
    <% if (player.permission == 'admin') { %>
        <a href=""><i class="fas fa-play-circle"></i></a>
    <% } %>
</div>

<div id="countdown" class="hidden">
    <span id="timer"></span>
    <% if (player.permission == 'admin') { %>
        <a href=""><i class="fas fa-stop-circle"></i></a>
    <% } %>
</div>

<div id="voteForm">
    <% if (player.permission == 'admin') { %>
        <button id="displayVote1" class="btn btn-warning cta hidden">‡πÇ‡∏´‡∏ß‡∏ï</button>
    <% } %>
    <div id="vote1" class="hidden">
        <h4>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏≥‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h4>
        <button data-vote="1" class="btn btn-warning"><i class="fas fa-thumbs-up"></i></button>
        <button data-vote="0" class="btn btn-warning"><i class="fas fa-thumbs-down"></i></button>
    </div>
    <div id="vote1Result" class="hidden">
        <h4>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h4>
        <span class="resultUp">
            <strong>
                <% if(resultVote1 !== null) {%><%= resultVote1.up %><% } %>
            </strong> <i class="fas fa-thumbs-up"></i>
        </span>
        <span class="resultDown">
            <strong>
                <% if(resultVote1 !== null) {%><%= resultVote1.down %><% } %>
            </strong> <i class="fas fa-thumbs-down"></i>
        </span>
    </div>
    <% if (player.permission == 'admin') { %>
        <button id="displayVote2" class="btn btn-warning cta hidden">‡πÇ‡∏´‡∏ß‡∏ï</button>
    <% } %>
    <div id="vote2" class="hidden">
        <h4>‡πÇ‡∏´‡∏ß‡∏ï‡∏£‡∏≠‡∏ö 2</h4>        
        <h4>‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®?</h4>
        <div class="vote2-choices"></div>
    </div>
    <div id="vote2Result" class="hidden">
        <h4>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h4>
        <ul id="playerList"></ul>
        <p id="finalResult"></p>
    </div>
</div>

<div id="status" class="hidden">
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ <strong>‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°</strong> ‡∏´‡∏£‡∏∑‡∏≠ <strong> ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô </strong> ...</p>
</div>



<!-- CHAT UI (re-styled) -->
<div id="chatBox" class="chat-box" aria-hidden="true" style="display:none;">
    <div class="chat-header">
        <div class="chat-title">üí¨ CHAT</div>
        <button id="closeChat" class="chat-close" aria-label="Close chat">‚úï</button>
    </div>
    
    <!-- ‡∏¢‡πâ‡∏≤‡∏¢ replyPreview ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    <div id="replyPreview" class="chat-reply-preview-bar" style="display:none;">
        <div class="reply-content">
            <span class="reply-indicator">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö </span>
            <span class="reply-player-name"></span>: 
            <span class="reply-message-content"></span>
        </div>
        <button class="reply-cancel-btn" aria-label="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö">‚úï</button>
    </div>

    <div id="chatMessages" class="chat-messages" role="log" aria-live="polite"></div>
    
    <% if (player.role === '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°') { %>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏° -->
    <div class="gm-quick-reply">
        <span class="gm-quick-label">üé≠ ‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô:</span>
        <button class="gm-reply-btn gm-yes" data-reply="yes" title="‡πÉ‡∏ä‡πà">‚úÖ ‡πÉ‡∏ä‡πà</button>
        <button class="gm-reply-btn gm-no" data-reply="no" title="‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà">‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</button>
        <button class="gm-reply-btn gm-maybe" data-reply="maybe" title="‡∏≠‡∏≤‡∏à‡∏à‡∏∞">ü§î ‡∏≠‡∏≤‡∏à‡∏à‡∏∞</button>
    </div>
    <% } %>
    
    <!-- ‡∏¢‡πâ‡∏≤‡∏¢ chat-input-wrap ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î) -->
    <div class="chat-input-wrap">
        <textarea id="chatInput" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." aria-label="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></textarea>
        <button id="sendChat" class="btn-chat-send" aria-label="‡∏™‡πà‡∏á">‡∏™‡πà‡∏á</button>
    </div>
</div>

<button id="toggleChat" class="chat-toggle" aria-expanded="false" aria-controls="chatBox">
    CHAT <span id="chatUnreadDot" class="unread-dot" style="display:none;"></span>
</button>

<!-- üîî Notification Center (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°) -->
<div id="notificationCenter" class="notification-center"></div>

<%- contentFor('footer') %>
<!-- Return to Lobby Popup (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô) -->
<div id="returnToLobbyModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:999999; align-items:center; justify-content:center;">
    <div style="background:#222; color:#fff; padding:32px 48px; border-radius:12px; text-align:center; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
        <h3 style="margin-bottom:16px;">üéÆ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß!</h3>
        <p style="font-size:18px; margin-bottom:12px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö Lobby...</p>
        <p style="font-size:24px; font-weight:bold; color:#f39c12;" id="returnCountdown">5</p>
    </div>
</div>

<% if (player.permission == 'admin') { %>
<div id="adminRevealModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:99999; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:24px; border-radius:8px; min-width:300px; max-width:90vw; margin:40px auto;">
        <h4>‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏¢: <span id="modalWord"></span></h4>
        <h5>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h5>
        <ul id="modalRoles"></ul>
        <button id="closeAdminReveal" class="btn btn-danger">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>
<% } %>

<%- contentFor('style') %>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    /* Popup ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á - Modern Style */
    .room-popup {
        max-width: 480px !important;
        border-radius: 20px !important;
        border: 3px solid #333 !important;
        background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%) !important;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.05) inset !important;
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    .room-popup .swal2-title {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        margin: 0 !important;
        padding: 20px 24px !important;
        font-family: 'Orbitron', sans-serif !important;
        font-size: 1.4em !important;
        font-weight: 700 !important;
        color: #fff !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .room-popup .swal2-html-container {
        margin: 0 !important;
        padding: 24px !important;
        overflow: visible !important;
    }
    
    .room-popup .swal2-actions {
        padding: 0 24px 24px !important;
        gap: 12px !important;
    }
    
    .room-form-group {
        margin-bottom: 20px;
    }
    
    .room-form-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-weight: 600;
        color: #aaa;
        font-size: 0.95em;
        font-family: 'Rajdhani', sans-serif;
    }
    
    .room-form-label .icon {
        font-size: 1.1em;
    }
    
    .room-form-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #333;
        border-radius: 12px;
        background: #0d0d1a;
        color: #fff;
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.1em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-sizing: border-box;
    }
    
    .room-form-input:focus {
        outline: none;
        border-color: #e74c3c;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
    }
    
    .room-form-input::placeholder {
        color: #555;
        font-weight: 400;
    }
    
    /* Slider Style */
    .room-slider-container {
        position: relative;
        padding: 10px 0;
    }
    
    .room-slider {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(90deg, #333 0%, #333 100%);
        outline: none;
        transition: all 0.3s;
    }
    
    .room-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        cursor: pointer;
        border: 3px solid #fff;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        transition: all 0.2s;
    }
    
    .room-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
    }
    
    .room-slider::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        cursor: pointer;
        border: 3px solid #fff;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }
    
    .room-slider-value {
        position: absolute;
        right: 0;
        top: -5px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: #fff;
        padding: 6px 14px;
        border-radius: 20px;
        font-family: 'Orbitron', sans-serif;
        font-weight: 700;
        font-size: 1em;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }
    
    /* Button Styles */
    .room-btn-confirm {
        padding: 14px 28px !important;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
        border: none !important;
        border-radius: 12px !important;
        color: #fff !important;
        font-family: 'Rajdhani', sans-serif !important;
        font-weight: 700 !important;
        font-size: 1.1em !important;
        cursor: pointer;
        transition: all 0.3s !important;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }
    
    .room-btn-confirm:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4) !important;
    }
    
    .room-btn-cancel {
        padding: 14px 28px !important;
        background: transparent !important;
        border: 2px solid #555 !important;
        border-radius: 12px !important;
        color: #aaa !important;
        font-family: 'Rajdhani', sans-serif !important;
        font-weight: 700 !important;
        font-size: 1.1em !important;
        cursor: pointer;
        transition: all 0.3s !important;
    }
    
    .room-btn-cancel:hover {
        border-color: #888 !important;
        color: #fff !important;
        background: rgba(255,255,255,0.05) !important;
    }
    
    /* Vote 2 - Player Buttons */
    #vote2 {
        background: transparent !important;
    }
    
    .vote2-choices {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-top: 25px;
        padding: 10px;
        background: transparent !important;
    }
    
    .btn-vote2-player {
        padding: 20px 40px;
        font-size: 1.4em;
        font-weight: 700;
        font-family: 'Rajdhani', sans-serif;
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: 4px solid #c0392b;
        border-radius: 16px;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        min-width: 150px;
        text-shadow: 2px 2px 3px rgba(0,0,0,0.4);
        position: relative;
        overflow: hidden;
    }
    
    .btn-vote2-player::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
    }
    
    .btn-vote2-player:hover::before {
        left: 100%;
    }
    
    .btn-vote2-player:hover {
        transform: translateY(-5px) scale(1.08);
        box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        border-color: #a93226;
    }
    
    .btn-vote2-player:active {
        transform: translateY(-2px) scale(1.02);
    }
    
    .btn-vote2-player.ghost {
        opacity: 0.5;
        background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
        border-color: #6c7a7d;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    #vote2 h4 {
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.4em;
        margin-bottom: 10px;
    }
</style>
         
<%- contentFor('script') %>
<style>
    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô */
    #playerSidebar {
        position: fixed;
        top: 0;
        right: 0;          /* ‡∏ï‡∏£‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤ */
        width: 240px;
        height: 100%;
        background-color: #2d2d2d;
        color: #fff;
        padding: 15px;
        box-shadow: -3px 0 10px rgba(0,0,0,0.3);
        z-index: 10002;
        transition: transform 0.3s ease-in-out, opacity 0.2s ease-in-out, visibility 0.2s;
        overflow-y: auto;
        transform: translateX(100%);  /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ô‡∏≠‡∏Å‡∏à‡∏≠ */
        opacity: 0;                    /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô */
        visibility: hidden;            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ */
        pointer-events: none;          /* ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î */
    }

    #playerSidebar.open {
        transform: translateX(0);
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    #onlinePlayers {
        padding: 0; 
        padding-top: 10px;
    }

    #onlinePlayers h4 {
        color: #fff;
        margin-bottom: 15px;
        font-size: 1.1em;
    }

    #onlinePlayerList {
        list-style-type: none;
        padding: 0;
        margin-bottom: 20px;
    }

    #onlinePlayerList li {
        margin-bottom: 8px;
        font-size: 0.95em;
        display: flex;
        align-items: center;
    }

    #onlinePlayerList li i {
        margin-right: 8px;
        font-size: 0.7em;
    }

    .status-online {
        color: #28a745;
    }

    .status-disconnected {
        color: #ffc107;
    }

    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á - ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
    #toggleSidebarBtn {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 10001;
        background-color: #343a40;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75em;
        white-space: nowrap;
    }

    #toggleSidebarBtn i {
        margin-right: 4px;
    }

    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Overlay */
    #sidebarOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 10000;
        display: none;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    @media (max-width: 768px) {
        #playerSidebar {
            width: 85%;
            max-width: 280px;
            right: -85%;
        }

        #playerSidebar.open {
            right: 0;
        }

        #toggleSidebarBtn {
            top: auto;
            bottom: 75px;
            right: 10px;
            padding: 8px 12px;
            font-size: 0.7em;
            border-radius: 20px;
        }

        #onlinePlayerList li {
            font-size: 0.85em;
        }
    }

    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏ó */
    /* Chat styles */
.chat-box {
    position: fixed;
    bottom: 100px;
    right: 15px;
    width: 380px;
    max-width: 95vw;
    height: 450px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    border: 2px solid #333;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    overflow: hidden;
    z-index: 10003;
    display: none;
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    display: flex;
    flex-direction: column;
}

.chat-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 12px 16px;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    border-bottom: none;
    font-weight:700;
    font-size: 1rem;
}

.chat-title {
    letter-spacing: 0.06em;
    color: #fff;
}

.chat-close {
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    color: #fff;
    padding: 4px 10px;
    border-radius: 6px;
    transition: all 0.2s;
}
.chat-close:hover { background: rgba(255,255,255,0.3); }

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 14px;
    font-size: 0.95rem;
    line-height: 1.4;
    color: #fff;
    background: transparent;
    display: flex;
    flex-direction: column;
}

/* Base style for each message wrapper (div.chat-message-wrapper) */
.chat-message-wrapper {
    display: flex;
    flex-direction: column;
    margin-bottom: 8px;
    max-width: 80%; /* Limit bubble width */
}

/* Align other messages (default) to the left */
.chat-message-wrapper.other {
    align-self: flex-start;
    text-align: left;
}

/* Align self messages to the right */
.chat-message-wrapper.self {
    align-self: flex-end;
    text-align: right;
}

/* Style for the message bubble itself */
.chat-message-bubble {
    padding: 8px 12px;
    border-radius: 18px;
    word-wrap: break-word;
    background-color: #2d3748; /* Dark background for others */
    color: #fff;
    font-size: 0.9em;
    line-height: 1.4;
    position: relative;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    display: inline-block; /* Make bubble adapt to content */
}

/* Distinct color for self message bubble */
.chat-message-wrapper.self .chat-message-bubble {
    background-color: #e74c3c; /* Red for self */
    color: #fff;
}

/* Style for timestamp/info */
.chat-message-info {
    font-size: 0.75em;
    color: #aaa;
    margin-top: 2px;
    /* Aligned by parent .chat-message-wrapper */
}

/* Adjust info color for self messages */
.chat-message-wrapper.self .chat-message-info {
    color: #ccc; /* Lighter for self info */
}

/* Style for player name inside bubble */
.chat-message-name {
    font-weight: bold;
    margin-right: 5px;
    font-size: 0.85em;
    display: inline; /* Keep name on same line as message text */
    color: #fff;
}

/* Adjust name color for self messages to ensure readability */
.chat-message-wrapper.self .chat-message-name {
    color: #fff;
}

/* Input area */
.chat-input-wrap {
    display:flex;
    gap:8px;
    padding:10px;
    border-top: 1px solid rgba(0,0,0,0.04);
    background: transparent;
    align-items: center;
}
#chatInput {
    flex:1;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #d1d5db;
    resize: none;
    background: #fff;
    font-size: 0.95rem;
    line-height:1.25;
    min-height:34px;
    max-height:100px; /* <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 80px ‡πÄ‡∏õ‡πá‡∏ô 100px ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
}
.btn-chat-send {
    padding:8px 12px;
    border-radius:8px;
    background:#ffb703;
    color:#000;
    border:none;
    font-weight:700;
    cursor:pointer;
    box-shadow: 0 6px 12px rgba(255,183,3,0.12);
}

.btn-chat-send:active { transform: translateY(1px); }

/* GM Quick Reply Buttons */
.gm-quick-reply {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    border-top: 1px solid #444;
}

.gm-quick-label {
    font-size: 0.85em;
    color: #a0aec0;
    white-space: nowrap;
}

.gm-reply-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.gm-reply-btn.gm-yes {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: #fff;
}
.gm-reply-btn.gm-yes:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
}

.gm-reply-btn.gm-no {
    background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
    color: #fff;
}
.gm-reply-btn.gm-no:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
}

.gm-reply-btn.gm-maybe {
    background: linear-gradient(135deg, #f6e05e 0%, #ecc94b 100%);
    color: #744210;
}
.gm-reply-btn.gm-maybe:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(236, 201, 75, 0.4);
}

/* GM Reply Reaction (emoji after message) */
.gm-reaction {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 6px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 1.1em;
    animation: reactionPop 0.3s ease-out;
}

.gm-reaction.yes { background: rgba(72, 187, 120, 0.3); }
.gm-reaction.no { background: rgba(229, 62, 62, 0.3); }
.gm-reaction.maybe { background: rgba(236, 201, 75, 0.3); }

@keyframes reactionPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* Toggle button */
.chat-toggle {
    position: fixed;
    bottom: 40px;
    right: 15px;
    z-index: 10004;
    background: #111827;
    color: #ffffff;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    font-weight: 800;
    letter-spacing: 0.06em;
    cursor: pointer;
    box-shadow: 0 8px 18px rgba(0,0,0,0.18);
}
.chat-toggle:active { transform: translateY(1px); }

/* Unread red dot */
.unread-dot {
    display:inline-block;
    width:10px;
    height:10px;
    background:#e11d48; /* red */
    border-radius:50%;
    margin-left:8px;
    vertical-align:middle;
    box-shadow: 0 0 0 rgba(225,29,72,0.6);
    animation: chatPulse 1.4s infinite;
}
@keyframes chatPulse {
    0% { transform: scale(1); opacity:1; }
    50% { transform: scale(1.45); opacity:0.75; }
    100% { transform: scale(1); opacity:1; }
}

/* GM Selected Message */
.chat-message-wrapper.gm-selected .chat-message-bubble {
    outline: 3px solid #f6e05e !important;
    outline-offset: 2px;
    animation: selectedPulse 1s ease-in-out infinite;
}

@keyframes selectedPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(246, 224, 94, 0.4); }
    50% { box-shadow: 0 0 15px 5px rgba(246, 224, 94, 0.3); }
}

/* Clickable message for GM */
<% if (typeof player !== 'undefined' && player.role === '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°') { %>
.chat-message-wrapper.other .chat-message-bubble {
    cursor: pointer;
    transition: all 0.2s;
}
.chat-message-wrapper.other .chat-message-bubble:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 10px rgba(255,255,255,0.1);
}
<% } %>

/* small screens */
@media (max-width: 480px) {
    .chat-box { width: 95%; right: 2.5%; left: 2.5%; bottom: 80px; height: 400px; }
    .chat-toggle { right: 2.5%; }
    .gm-quick-reply { flex-wrap: wrap; }
    .gm-quick-label { width: 100%; margin-bottom: 6px; }
    .gm-reply-btn { font-size: 0.8em; padding: 6px 8px; }
}

/* Reply Preview Bar */
.chat-reply-preview-bar {
    background-color: #e0e0e0;
    padding: 8px 12px;
    border-radius: 10px 10px 0 0;
    margin-bottom: -1px; /* Overlap with input border */
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%; /* Ensure it spans the input width */
    font-size: 0.85em;
    color: #555;
    border-bottom: 1px solid #d1d5db;
    box-sizing: border-box; /* Include padding/border in width */
}

.chat-reply-preview-bar .reply-content {
    flex-grow: 1;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis; /* Truncate long content */
    margin-right: 10px;
}

.chat-reply-preview-bar .reply-indicator {
    font-weight: bold;
    color: #333;
    margin-right: 5px;
}
.chat-reply-preview-bar .reply-player-name {
    font-weight: bold;
    color: #333; /* Will be overwritten by JS color if available */
}
.chat-reply-preview-bar .reply-message-content {
    color: #666;
}

.reply-cancel-btn {
    background: none;
    border: none;
    color: #666;
    font-size: 1.1em;
    cursor: pointer;
    padding: 0 5px;
    line-height: 1;
}
.reply-cancel-btn:hover {
    color: #333;
}

/* Style for reply indicator inside message bubble (when viewing a message that is a reply) */
.chat-message-bubble .reply-to-text {
    font-size: 0.75em;
    color: #666; /* Default color for other's reply indicator */
    margin-bottom: 5px;
    padding-bottom: 5px;
    border-bottom: 1px solid rgba(0,0,0,0.1); /* Subtle separator */
    display: block;
    word-wrap: break-word;
    max-height: 3em; /* Limit height of original message snippet */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Specific style for self's reply indicator */
.chat-message-wrapper.self .chat-message-bubble .reply-to-text {
    color: #333; /* Darker for self's reply indicator */
    border-bottom-color: rgba(0,0,0,0.2);
}

/* Ensure name in reply-to-text uses its color */
.chat-message-bubble .reply-to-text .reply-name {
    font-weight: bold;
}

/* Notification Center - positioned at top to not block buttons */
.notification-center {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10005;
    width: 90%;
    max-width: 400px;
    pointer-events: none; /* ‡πÉ‡∏´‡πâ notification ‡πÑ‡∏°‡πà‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å */
}

.notification {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    font-size: 1.1em;
    font-weight: bold;
    animation: slideIn 0.3s ease-out, slideOut 0.3s ease-out 4.7s;
    pointer-events: auto;
}

.notification.success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.notification.error {
    background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

.notification.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.notification.info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOut {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-30px);
    }
}
</style>
<script src="/socket.io/socket.io.js"></script>
<script>
$(function() {
    var socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 500,
        reconnectionDelayMax: 5000,
        randomizationFactor: 0.5,
        timeout: 30000,
        transports: ['websocket', 'polling'],
        upgrade: true,
        forceNew: false
    });

    // Socket.IO connection monitoring
    socket.on('connect', function() {
        console.log('[Socket] Connected:', socket.id);
        $('#connectionStatus').hide();
    });

    socket.on('disconnect', function(reason) {
        console.log('[Socket] Disconnected:', reason);
        if (reason !== 'io server disconnect') {
            $('#connectionStatus').text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...').show();
        }
    });

    socket.on('reconnect', function(attemptNumber) {
        console.log('[Socket] Reconnected after', attemptNumber, 'attempts');
        $('#connectionStatus').hide();
        // Re-join room after reconnect
        socket.emit('joinRoom', { roomId: '<%= room.roomId %>' });
    });

    socket.on('reconnect_attempt', function(attemptNumber) {
        console.log('[Socket] Reconnect attempt:', attemptNumber);
    });

    socket.on('reconnect_error', function(error) {
        console.log('[Socket] Reconnect error:', error.message);
    });

    var replyingTo = null; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
    var wordSubmitted = false; // flag ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á
    function toggleSidebar() {
        $('#playerSidebar').toggleClass('open');
        $('#sidebarOverlay').toggle(); // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á overlay
    }

    function displayPlayerStatus(online, offline) {
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ online/offline ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
        // ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ updateOnlinePlayerList ‡πÅ‡∏ó‡∏ô
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ
        $('.playerStatus').html('');
        for (var i = 0; i < online; i++) {
            $('.playerStatus').append('<i class="fas fa-circle online"></i>')
        }
        for (var i = 0; i < offline; i++) {
            $('.playerStatus').append('<i class="fas fa-circle offline"></i>')
        }
    }

    // Store current room players for admin controls
    let currentRoomPlayers = [];

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á object { playerId, playerName, color, permission }
    function updateOnlinePlayerList(players) {
        currentRoomPlayers = players; // Store for admin controls
        
        $('#onlinePlayerList').empty();
        $('#kickPlayerSelect').empty();
        $('#kickPlayerSelect').append('<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...</option>');
        
        if (players.length === 0) {
            $('#onlinePlayerList').append('<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</li>');
        } else {
            players.forEach(function(player) {
                const isAdmin = player.permission === 'admin';
                const isCurrentPlayer = player.playerId === playerId;
                const playerNameHtml = `<span style="color: ${player.color || '#333'};">${escapeHtml(player.playerName)}</span>`;
                const adminBadge = isAdmin ? ' <span style="color: #e74c3c;">üëë</span>' : '';
                $('#onlinePlayerList').append(`<li><i class="fas fa-circle status-online"></i> ${playerNameHtml}${adminBadge}</li>`);
                
                // Add to kick select (exclude current player and admin)
                if (!isCurrentPlayer && !isAdmin) {
                    $('#kickPlayerSelect').append(`<option value="${player.playerId}">${escapeHtml(player.playerName)}</option>`);
                }
            });
        }
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }
    
    // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á
    $('#toggleSidebarBtn').on('click', toggleSidebar);
    $('#closeSidebarBtn').on('click', toggleSidebar);
    $('#sidebarOverlay').on('click', toggleSidebar); // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà overlay ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á

    // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
    $('#leaveRoomBtn').on('click', function() {
        Swal.fire({
            icon: 'question',
            title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?',
            text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            background: '#1e1e1e',
            color: '#fff',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#555',
            confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á...',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    background: '#1e1e1e',
                    color: '#fff',
                    didOpen: () => { Swal.showLoading(); }
                });
                
                socket.emit('leaveRoom', {}, function(response) {
                    window.location.href = '/rooms?playerId=' + playerId;
                });
                
                // Fallback
                setTimeout(function() {
                    window.location.href = '/rooms?playerId=' + playerId;
                }, 2000);
            }
        });
    });

    // Admin Controls
    <% if (room.admin) { %>
        // Update Room
        $('#updateRoomBtn').on('click', function() {
            const currentRoomName = '<%= room.name %>';
            const currentMaxPlayers = <%= room.maxPlayers %>;
            const currentRoundTime = <%= room.settings ? Math.floor(room.settings.roundTime / 60) : 5 %>;
            
            Swal.fire({
                title: '‚öôÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á',
                customClass: {
                    popup: 'room-popup',
                    confirmButton: 'room-btn-confirm',
                    cancelButton: 'room-btn-cancel'
                },
                html: `
                    <div style="font-family: 'Rajdhani', sans-serif;">
                        <div class="room-form-group">
                            <label class="room-form-label">
                                <span class="icon">üìù</span> ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á:
                            </label>
                            <input id="editRoomName" class="room-form-input" value="${currentRoomName}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." maxlength="20">
                        </div>
                        
                        <div class="room-form-group">
                            <label class="room-form-label">
                                <span class="icon">üë•</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:
                            </label>
                            <div class="room-slider-container">
                                <span class="room-slider-value" id="editMaxPlayersValue">${currentMaxPlayers}</span>
                                <input type="range" id="editMaxPlayers" class="room-slider" min="3" max="10" value="${currentMaxPlayers}">
                            </div>
                        </div>
                        
                        <div class="room-form-group">
                            <label class="room-form-label">
                                <span class="icon">‚è±Ô∏è</span> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö:
                            </label>
                            <div class="room-slider-container">
                                <span class="room-slider-value" id="editRoundTimeValue">${currentRoundTime} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
                                <input type="range" id="editRoundTime" class="room-slider" min="1" max="10" value="${currentRoundTime}">
                            </div>
                        </div>
                    </div>
                `,
                background: 'transparent',
                showCancelButton: true,
                confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                focusConfirm: false,
                didOpen: () => {
                    // Slider handlers
                    const maxPlayersSlider = document.getElementById('editMaxPlayers');
                    const maxPlayersValue = document.getElementById('editMaxPlayersValue');
                    const roundTimeSlider = document.getElementById('editRoundTime');
                    const roundTimeValue = document.getElementById('editRoundTimeValue');
                    
                    function updateSliderBackground(slider) {
                        const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
                        slider.style.background = `linear-gradient(90deg, #e74c3c 0%, #e74c3c ${percent}%, #333 ${percent}%, #333 100%)`;
                    }
                    
                    maxPlayersSlider.addEventListener('input', function() {
                        maxPlayersValue.textContent = this.value;
                        updateSliderBackground(this);
                    });
                    
                    roundTimeSlider.addEventListener('input', function() {
                        roundTimeValue.textContent = this.value + ' ‡∏ô‡∏≤‡∏ó‡∏µ';
                        updateSliderBackground(this);
                    });
                    
                    updateSliderBackground(maxPlayersSlider);
                    updateSliderBackground(roundTimeSlider);
                },
                preConfirm: () => {
                    return {
                        name: document.getElementById('editRoomName').value.trim(),
                        maxPlayers: parseInt(document.getElementById('editMaxPlayers').value),
                        roundTime: parseInt(document.getElementById('editRoundTime').value)
                    };
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    socket.emit('updateRoom', result.value, function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: response.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
                            });
                        }
                    });
                }
            });
        });

        // Transfer Admin
        $('#transferAdminBtn').on('click', function() {
            const otherPlayers = currentRoomPlayers.filter(p => p.playerId !== playerId);
            
            if (otherPlayers.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏î‡πâ'
                });
                return;
            }
            
            const options = otherPlayers.map(p => `<option value="${p.playerId}">${escapeHtml(p.playerName)}</option>`).join('');
            
            Swal.fire({
                title: '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ Admin',
                html: `
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥:</label>
                    <select id="newAdminSelect" class="swal2-select" style="width: 100%;">
                        ${options}
                    </select>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    return document.getElementById('newAdminSelect').value;
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    socket.emit('transferAdmin', { newAdminPlayerId: result.value }, function(response) {
                        if (!response.success) {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÇ‡∏≠‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: response.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
                            });
                        }
                        // Success handled by adminTransferred event
                    });
                }
            });
        });

        // Kick Player
        $('#kickPlayerBtn').on('click', function() {
            const targetPlayerId = $('#kickPlayerSelect').val();
            if (!targetPlayerId) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',
                    text: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞'
                });
                return;
            }
            
            Swal.fire({
                icon: 'warning',
                title: '‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ?',
                showCancelButton: true,
                confirmButtonText: '‡πÄ‡∏ï‡∏∞',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    socket.emit('kickPlayer', { targetPlayerId: targetPlayerId }, function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏ï‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: response.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
                            });
                        }
                    });
                }
            });
        });
    <% } %>

    // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (footer)
    $(document).on('click', '#showWordAndRoles', function() {
        socket.emit('admin_request_word_roles');
    });
    $(document).on('click', '#closeAdminReveal', function() {
        $('#adminRevealModal').hide();
    });
    socket.on('admin_word_roles', function(data) {
        $('#modalWord').text(data.word);
        $('#modalRoles').empty();
        data.players.forEach(function(p) {
            $('#modalRoles').append('<li>' + p.name + ' : ' + p.role + '</li>');
        });
        $('#adminRevealModal').show();
    });

    // ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage =====
    function getGameSettings() {
        return JSON.parse(localStorage.getItem('gameSettings') || '{}');
    }
    
    function shouldConfirmLeave() {
        const settings = getGameSettings();
        return settings.confirmLeave !== false; // default ‡πÄ‡∏õ‡πá‡∏ô true
    }
    
    // ===== ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö / ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ =====
    let allowNavigation = false; // flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ navigate ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à
    let isShowingConfirm = false; // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á popup ‡∏≠‡∏¢‡∏π‡πà
    
    // ===== ‡∏ß‡∏¥‡∏ò‡∏µ Hash-based + Multiple History Entries (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô back ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) =====
    function setupBackBlocker() {
        history.replaceState({ page: 'game', index: 0 }, '', location.pathname + location.search);
        for (let i = 1; i <= 3; i++) {
            history.pushState({ page: 'game', index: i }, '', location.pathname + location.search + '#ingame');
        }
    }
    setupBackBlocker();
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°
    function leaveGameAndRedirect() {
        allowNavigation = true;
        socket.emit('leaveRoom', { roomId: roomId, playerId: playerId });
        setTimeout(() => {
            window.location.href = '/room/' + '<%= room.roomId %>' + '?playerId=' + '<%= player.playerId %>';
        }, 150);
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á confirm dialog
    function showLeaveConfirmation() {
        if (isShowingConfirm) return;
        isShowingConfirm = true;
        
        // ‡πÉ‡∏™‡πà blocker ‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á popup
        setupBackBlocker();
        
        Swal.fire({
            icon: 'warning',
            title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡∏´‡∏£‡∏∑‡∏≠?',
            text: '‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏° ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏°‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤',
            showCancelButton: true,
            confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°',
            cancelButtonText: '‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≠',
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#3085d6',
            background: '#1e1e1e',
            color: '#fff',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then((result) => {
            isShowingConfirm = false;
            if (result.isConfirmed) {
                leaveGameAndRedirect();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚Üí ‡πÉ‡∏™‡πà blocker ‡∏Å‡∏•‡∏±‡∏ö
                setupBackBlocker();
            }
        });
    }
    
    // 1. ‡∏î‡∏±‡∏Å popstate (‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏Å‡∏î back)
    window.addEventListener('popstate', function(e) {
        if (allowNavigation) return;
        
        // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£ back ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        e.preventDefault();
        
        if (!shouldConfirmLeave()) {
            leaveGameAndRedirect();
            return;
        }
        
        if (!isShowingConfirm) {
            showLeaveConfirmation();
        } else {
            setupBackBlocker();
        }
    });
    
    // 2. ‡∏î‡∏±‡∏Å hashchange (backup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á browser)
    window.addEventListener('hashchange', function(e) {
        if (allowNavigation) return;
        
        // ‡∏ñ‡πâ‡∏≤ hash ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (user ‡∏Å‡∏î back)
        if (!location.hash || location.hash !== '#ingame') {
            e.preventDefault();
            setupBackBlocker();
            
            if (!shouldConfirmLeave()) {
                leaveGameAndRedirect();
                return;
            }
            
            if (!isShowingConfirm) {
                showLeaveConfirmation();
            }
        }
    });
    
    // 3. ‡∏î‡∏±‡∏Å beforeunload (‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏¥‡∏î tab/refresh)
    window.addEventListener('beforeunload', function(e) {
        if (allowNavigation) return;
        if (!shouldConfirmLeave()) {
            // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Üí ‡∏™‡πà‡∏á leaveRoom ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
            navigator.sendBeacon('/api/leave-room', JSON.stringify({
                roomId: roomId,
                playerId: playerId
            }));
            return;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á dialog ‡∏Ç‡∏≠‡∏á browser (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á leaveRoom)
        e.preventDefault();
        e.returnValue = '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠?';
        return e.returnValue;
    });
    
    // 4. ‡∏î‡∏±‡∏Å pagehide (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile browsers - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß)
    window.addEventListener('pagehide', function(e) {
        // ‡∏ñ‡πâ‡∏≤ allowNavigation = true ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á leave
        if (allowNavigation) return;
        
        // ‡∏™‡πà‡∏á leaveRoom ‡∏ú‡πà‡∏≤‡∏ô sendBeacon ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ
        navigator.sendBeacon('/api/leave-room', JSON.stringify({
            roomId: roomId,
            playerId: playerId
        }));
    });
    
    // 5. ‡∏î‡∏±‡∏Å visibilitychange (‡πÄ‡∏°‡∏∑‡πà‡∏≠ user ‡∏™‡∏•‡∏±‡∏ö tab ‡∏´‡∏£‡∏∑‡∏≠ minimize)
    let wasHidden = false;
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            wasHidden = true;
            sessionStorage.setItem('hiddenTime', Date.now().toString());
        } else if (wasHidden) {
            wasHidden = false;
            socket.emit('checkRoomStatus', { roomId: roomId, playerId: playerId });
        }
    });

    function soundNotify(notifType) {
        let audiof;
        switch (notifType) {
          case 'popup':
            audiof = new Audio('/static/sound/popup.mp3');
            break;
          case 'message':
            audiof = new Audio('/static/sound/message.mp3');
            break;
          case 'mysterious':
            audiof = new Audio('/static/sound/mysterious.mp3');
            break;
          case 'ding':
            audiof = new Audio('/static/sound/ding.mp3');
            break;
          case 'dong':
            audiof = new Audio('/static/sound/dong.mp3');
            break;
          case 'tada':
            audiof = new Audio('/static/sound/tada.mp3');
            break;
          default:
            audiof = new Audio('/static/sound/ding.mp3');
        }
        
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏° catch error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô console error
        audiof.play().catch(function(e) {
            // Browser ‡∏≠‡∏≤‡∏à block autoplay - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
        });
    }

    function addPlayerVote(player, checked) {
        const ghostClass = player.isGhost ? 'ghost' : '';
        const btn = `<button class="btn btn-vote2-player ${ghostClass}" data-player="${player.name}">${player.name}</button>`;
        $('#vote2 .vote2-choices').append(btn);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô element ‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á step ‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ vote1 ‡πÅ‡∏•‡πâ‡∏ß)
    function hideAllGameElements() {
        $('#waiting, #reset .role, #chooseWord, #reveal button, #word, #startGame, #countdown, #vote2, #vote2Result, #status').hide();
    }

    function updateCountdown(counter) {
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏õ‡πá‡∏ô mm:ss
        var minutes = Math.floor(counter / 60);
        var seconds = counter % 60;
        var display = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        $("#timer").html(display);
    }

    function getResultIssue(result) {
        let message = '';
        if (result.hasTraitor) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡πÉ‡∏ô‡πÄ‡∏Å‡∏°
            if (result.hasWon) {
                message = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! <br/>‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏Ñ‡∏∑‡∏≠: ${result.finalTraitorName}`;
            } else {
                message = `‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏ä‡∏ô‡∏∞! ‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡∏ï‡∏û‡∏•‡∏≤‡∏î <br/>‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏Ñ‡∏∑‡∏≠: ${result.finalTraitorName}`;
            }
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡πÉ‡∏ô‡πÄ‡∏Å‡∏°
            if (result.hasWon) {
                message = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! <br/>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ (‡πÄ‡∏à‡∏≠ Ghost Player)`;
            } else {
                message = `‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡∏ï‡∏û‡∏•‡∏≤‡∏î! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏ß‡∏ï‡∏û‡∏•‡∏≤‡∏î`;
            }
        }
        return message;
    }

    $('.appear').fadeIn().delay(3000).fadeOut();

    // Submit word via Socket.IO (acknowledged) - SIMPLER VERSION
    var isSubmittingWord = false;
    
    function submitWord() {
        if (isSubmittingWord || wordSubmitted) {
            console.log('[Word] Already submitting or submitted');
            return;
        }
        
        isSubmittingWord = true;
        var wordVal = $('#wordInput').val().trim();
        console.log('[Word] Submitting:', wordVal || '(random)');
        
        // Disable button while submitting
        $('#wordForm button').prop('disabled', true).text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...');

        socket.emit('setWord', { word: wordVal }, function(response){
            console.log('[Word] Response:', response);
            isSubmittingWord = false;
            
            if (response && response.ok) {
                wordSubmitted = true;
                // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤ class 'current' ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ CSS ‡∏°‡∏µ .hidden.current { display: block !important }
                $("#chooseWord").removeClass('current').hide();
                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥
                $('#reveal button').removeClass('hidden').show();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                Swal.fire({ 
                    icon: 'success', 
                    title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°', 
                    timer: 3000,
                    showConfirmButton: false,
                    background: '#1e1e1e',
                    color: '#fff'
                });
                console.log('[Word] Success! Form hidden, reveal button shown');
            } else {
                // Reset button on error
                $('#wordForm button').prop('disabled', false).text('‡∏™‡πà‡∏á');
                var msg = (response && response.error) ? response.error : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥';
                console.log('[Word] Error:', msg);
                Swal.fire({ 
                    icon: 'error', 
                    title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                    text: msg, 
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    background: '#1e1e1e',
                    color: '#fff'
                });
            }
        });
        
        // Timeout fallback: if no response in 5 seconds, reset
        setTimeout(function() {
            if (isSubmittingWord) {
                console.log('[Word] Timeout - no response');
                isSubmittingWord = false;
                $('#wordForm button').prop('disabled', false).text('‡∏™‡πà‡∏á');
            }
        }, 5000);
    }
    
    $("#wordForm").submit(function(e) {
        e.preventDefault();
        submitWord();
    });
    
    // Also handle direct button click
    $('#wordForm button').on('click', function(e) {
        e.preventDefault();
        submitWord();
    });

    // newGame: prevent immediate double-submit but re-enable after 2s (do not disable forever)
    $("#newGame").click(function(){
        var $btn = $(this);
        if ($btn.data('disabled')) return;
        $btn.data('disabled', true);
        socket.emit('resetGame');
        setTimeout(function(){ $btn.data('disabled', false); }, 2000);
    });

    // startGame anchor: short client-side debounce to avoid instant double-clicks
    $("#startGame a").click(function(e){
        var $a = $(this);
        if ($a.data('disabled')) { e.preventDefault(); return; }
        $a.data('disabled', true);
        console.log('[startGame click] Emitting startGame');
        socket.emit('startGame');
        $("#startGame").hide();
        $("#countdown").removeClass('hidden').fadeIn();
        setTimeout(function(){ $a.data('disabled', false); }, 2000);
        e.preventDefault();
    });

    $( "#countdown a").click(function(e){
        socket.emit('wordFound');
        e.preventDefault();
    });

    // Vote1 ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ displayVote1 ‡πÅ‡∏•‡∏∞ vote1 handlers

    // Vote2 - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    $(document).on('click', '.btn-vote2-player', function(e) {
        e.preventDefault();
        const votedPlayer = $(this).data('player');
        socket.emit('vote2', {player: '<%= player.name %>', vote: votedPlayer});
        // ‡∏ã‡πà‡∏≠‡∏ô vote2 section ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏î
        $('#vote2').fadeOut();
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠
        $('#status p').html('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÇ‡∏´‡∏ß‡∏ï...');
        $('#status').removeClass('hidden').fadeIn();
    });

    $("#reveal button").click(function(){
        const $btn = $(this);
        if ($btn.prop('disabled')) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
        
        console.log('[revealWord] Sending reveal word event');
        $btn.prop('disabled', true).text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢...');
        
        socket.emit('revealWord');
        
        // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° (‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤ server ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•)
        setTimeout(function() {
            $btn.hide();
        }, 2000);
    });

    // Initialize player and room context
    const playerId = '<%= player.playerId || "" %>';
    const roomId = '<%= room.roomId %>';
    let isInitialized = false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ init ‡∏ã‡πâ‡∏≥

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö init room
    function initializeRoom() {
        if (isInitialized) {
            console.log('[initializeRoom] Already initialized, skipping');
            return;
        }
        socket.emit('initPlayer', playerId);
        socket.emit('setRoom', { roomId: roomId, playerId: playerId });
        isInitialized = true;
        console.log('[initializeRoom] Room initialized');
    }

    // Init ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    initializeRoom();
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô phase ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡πÜ
    <% if (status === 'role') { %>
        const myRole = '<%= player.role %>';
        const isGM = (myRole === '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°');
        console.log('[Init] My role:', myRole);
        
        // ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≤‡∏Å HTML) - ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥
        setTimeout(function() {
            $('#reset .role').hide();
            if(isGM) { 
                console.log('[Init] GM - showing word form (reveal button shows after submit)');
                $("#chooseWord").removeClass('hidden').show();
                // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß
            } else { 
                console.log('[Init] Others - showing wait message');
                $("#waiting").removeClass('hidden').show();
                $('#waiting p').html('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ <strong>‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°</strong> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥...');
            }
        }, 5000);
        
        soundNotify('mysterious');
    <% } %>


    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Socket.IO reconnect ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    socket.on('reconnect', function() {
        console.log('Socket reconnected');
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á init ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ socket ‡∏à‡∏∞ auto-rejoin room
        // ‡πÅ‡∏Ñ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            showConfirmButton: false,
            timer: 2000
        });
    });

    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡πâ‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô)
    socket.on('roomUpdate', function(data) {
        if (data.players) {
            updateOnlinePlayerList(data.players);
        }
    });

    // ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á
    socket.on('kickedFromRoom', function(data) {
        allowNavigation = true;
        Swal.fire({
            icon: 'warning',
            title: '‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á',
            text: data.message || '‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            background: '#1e1e1e',
            color: '#fff'
        }).then(() => {
            window.location.href = '/rooms?playerId=' + playerId;
        });
    });

    // ‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î
    socket.on('roomClosed', function(data) {
        allowNavigation = true;
        Swal.fire({
            icon: 'warning',
            title: '‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î',
            text: data.message || '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß',
            background: '#1e1e1e',
            color: '#fff',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            window.location.href = '/rooms?playerId=' + playerId;
        });
    });

    // ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏à‡∏≤‡∏Å Admin ‡∏£‡∏∞‡∏ö‡∏ö
    socket.on('kicked', function(data) {
        Swal.fire({
            icon: 'error',
            title: '‚ùå ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å',
            text: data.reason || '‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            background: '#1e1e1e',
            color: '#fff'
        }).then(() => {
            window.location.href = '/?playerId=' + playerId;
        });
    });

    // ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô - ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ banned ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    socket.on('banned', function(data) {
        Swal.fire({
            icon: 'error',
            title: 'üö´ ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô!',
            html: `<p><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${data.reason}</p><p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${data.durationHours === null ? '‡∏ñ‡∏≤‡∏ß‡∏£' : data.durationHours + ' ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á'}</p>`,
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            background: '#1e1e1e',
            color: '#fff',
            allowOutsideClick: false
        }).then(() => {
            window.location.href = '/banned?playerId=' + playerId;
        });
    });

    // ‡∏£‡∏±‡∏ö broadcast ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    socket.on('systemBroadcast', function(data) {
        Swal.fire({
            icon: 'info',
            title: 'üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
            text: data.message,
            background: '#1e1e1e',
            color: '#fff',
            confirmButtonColor: '#e74c3c'
        });
    });

    // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö/‡πÇ‡∏≠‡∏ô admin
    socket.on('adminTransferred', function(data) {
        Swal.fire({
            icon: 'success',
            title: data.message || '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß',
            timer: 2000,
            showConfirmButton: false
        });
        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á UI ‡πÉ‡∏´‡∏°‡πà
        setTimeout(function() {
            location.reload();
        }, 2000);
    });

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
    socket.on('nameInUse', function(data) {
        Swal.fire({
            icon: 'error',
            title: '‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!',
            text: data.message,
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/?playerId=' + playerId;
            }
        });
    });

    socket.on('newRole', function(data) {
        console.log('[newRole] Received:', data);
        wordSubmitted = false;
        $('.hidden').hide();
        $('#word').html('');
        $('#vote2 .vote2-choices').html('');
        $('#reveal button, #newGame, #vote1 button, #startGame a').attr("disabled", false); 

        // ‡∏ß‡∏ô‡∏´‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ playerId ‡∏´‡∏£‡∏∑‡∏≠ name)
        var myPlayer = null;
        $.each(data.players, function(i, obj) {
            if(obj.playerId == '<%= player.playerId %>' || obj.name == '<%= player.name %>') {
                myPlayer = obj;
                return false;
            }
        });
        
        if(myPlayer) {
            console.log('[newRole] My role:', myPlayer.role);
            $('.role strong').html(myPlayer.role);
            $('#reset .role').css('display', 'block');
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
            setTimeout(function() {
                $('#reset .role').hide();
                if(myPlayer.role == '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°' && !wordSubmitted) {
                    console.log('[newRole] GM - showing word form (reveal button shows after submit)');
                    $("#chooseWord").removeClass('hidden').show();
                    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ô submitWord callback)
                } else {
                    console.log('[newRole] Others - showing wait');
                    $("#waiting").removeClass('hidden').show();
                    $('#waiting p').html('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ <strong>‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°</strong> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏≥...');
                }
            }, 5000);
        } else {
            console.log('[newRole] Player not found in data!');
        }
        soundNotify('mysterious');
    });

    socket.on('revealWord', function(data) {
        console.log('[revealWord] Received:', data);
        
        // ‡∏ß‡∏ô‡∏´‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ playerId ‡∏´‡∏£‡∏∑‡∏≠ name)
        var myPlayer = null;
        $.each(data.players, function(i, obj) {
            if(obj.playerId == '<%= player.playerId %>' || obj.name == '<%= player.name %>') {
                myPlayer = obj;
                return false;
            }
        });

        if(myPlayer) {
            if(myPlayer.role == '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°' || myPlayer.role == '‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®') {
                $('#word').html("<span>‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠ <strong>"+data.word+"</strong></span>");
            } else {
                $('#word').html("<span>‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏® <br />‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ</span>");
            }
        }

        $('#word').removeClass('hidden').fadeIn(1000).delay(5000).fadeOut("slow", function() {
            $("#startGame").removeClass('hidden').fadeIn();
        });
        soundNotify('message');
    });

    // wordFound ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏õ displayVote2 ‡πÄ‡∏•‡∏¢‡∏à‡∏≤‡∏Å server
    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ listener ‡πÅ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß

    socket.on('displayVote2', function(players) {
        console.log('[displayVote2] Received - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏ß‡∏ï‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®');
        hideAllGameElements();
        $('#vote2 .vote2-choices').html('');
        players.forEach(function(votePlayer, index) {
            let checked = (index === 0 ? true : false);
            addPlayerVote(votePlayer, checked);
        });
        $('#vote2').removeClass('hidden').fadeIn();
        soundNotify('popup');
        showNotification('üéØ ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤! ‡πÇ‡∏´‡∏ß‡∏ï‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®', 'warning', 3000);
    });
    
    socket.on('vote2Ended', function(result) {
        console.log('[vote2Ended] Received:', result);
        hideAllGameElements();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï
        $('#vote2Result ul').html('');
        result.voteDetail.forEach(function(votePlayer, index) {
            $('#vote2Result ul').append('<li>'+votePlayer.name+' ('+votePlayer.nbVote2+' ‡πÇ‡∏´‡∏ß‡∏ï)</li>');
        });
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡πÄ‡∏Å‡∏° + ‡πÄ‡∏â‡∏•‡∏¢‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®
        finalResult = getResultIssue(result);
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏•‡∏¢‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        let rolesReveal = '<div class="roles-reveal" style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">';
        rolesReveal += '<h5 style="color: #f6e05e; margin-bottom: 10px;">üé≠ ‡πÄ‡∏â‡∏•‡∏¢‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</h5>';
        if (result.allRoles && result.allRoles.length > 0) {
            result.allRoles.forEach(function(p) {
                let roleIcon = 'üë§';
                let roleColor = '#fff';
                if (p.role === '‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®') { roleIcon = 'üî¥'; roleColor = '#ff6b6b'; }
                else if (p.role === '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°') { roleIcon = 'üü¢'; roleColor = '#51cf66'; }
                else if (p.role === '‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á') { roleIcon = 'üîµ'; roleColor = '#74c0fc'; }
                rolesReveal += '<div style="color: ' + roleColor + ';">' + roleIcon + ' <strong>' + p.name + '</strong>: ' + p.role + '</div>';
            });
        }
        rolesReveal += '</div>';
        
        $('#vote2Result #finalResult').html(finalResult + rolesReveal);
        $('#vote2Result').removeClass('hidden').fadeIn();
        soundNotify('tada');
        
        // Show game result notification
        if (result.hasWon) {
            showNotification('üéâ ‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ä‡∏ô‡∏∞! ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏Ñ‡∏∑‡∏≠: ' + (result.finalTraitorName || '‡πÑ‡∏°‡πà‡∏°‡∏µ'), 'success', 5000);
        } else {
            showNotification('üíÄ ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏ä‡∏ô‡∏∞! ‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏¢‡∏®‡∏Ñ‡∏∑‡∏≠: ' + (result.finalTraitorName || '???'), 'error', 5000);
        }
        // ADDED: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡∏•‡∏á
        $('#reveal button, #newGame, #vote1 button, #startGame a').attr("disabled", false); 
    });

    // Return to Lobby after game ends
    socket.on('returnToLobby', function(data) {
        var countdown = data.countdown || 5;
        $('#returnToLobbyModal').css('display', 'flex');
        $('#returnCountdown').text(countdown);
        
        var countdownInterval = setInterval(function() {
            countdown--;
            $('#returnCountdown').text(countdown);
            if (countdown <= 0) {
                clearInterval(countdownInterval);
            }
        }, 1000);
    });

    socket.on('redirectToLobby', function(data) {
        allowNavigation = true;
        window.location.href = '/room/' + data.roomId + '?playerId=' + playerId;
    });

    // Bug #1 Fix: ‡∏£‡∏±‡∏ö event restartGame ‡∏à‡∏≤‡∏Å admin dashboard
    socket.on('restartGame', function() {
        Swal.fire({
            icon: 'info',
            title: 'üîÑ ‡πÄ‡∏Å‡∏°‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï',
            text: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Lobby...',
            background: '#1e1e1e',
            color: '#fff',
            timer: 3000,
            showConfirmButton: false
        }).then(() => {
            allowNavigation = true;
            window.location.href = '/room/' + roomId + '?playerId=' + playerId;
        });
    });

    socket.on('playerStatusUpdate', function(playerStatus) {
        displayPlayerStatus(playerStatus.online, playerStatus.offline)
    });

    socket.on('countdownUpdate', function(counter) {
        console.log('[countdownUpdate] Received counter:', counter);
        hideAllGameElements();
        updateCountdown(counter);
        $("#countdown").removeClass('hidden').show();
    });

    socket.on('startGame', function() {
        console.log('[startGame event] Received');
        hideAllGameElements();
        $("#countdown").removeClass('hidden').fadeIn();
        soundNotify('ding');
    });

    // Toggle chat visibility
    $('#toggleChat').on('click', function() {
        var isVisible = $('#chatBox').is(':visible');
        if (!isVisible) {
            $('#chatBox').show();
            $(this).attr('aria-expanded', 'true');
            $('#chatUnreadDot').hide();
            $('#chatInput').focus();
        } else {
            $('#chatBox').hide();
            $(this).attr('aria-expanded', 'false');
        }
    });

    // Close chat button (inside)
    $(document).on('click', '#closeChat', function(){
        $('#chatBox').hide();
        $('#toggleChat').attr('aria-expanded', 'false');
    });

    // Enter to send (Shift+Enter => newline)
    $('#chatInput').on('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            $('#sendChat').trigger('click');
        }
    });

    // Click send
    $('#sendChat').on('click', function() {
        var msg = $('#chatInput').val().trim();
        if (msg) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /m ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin ‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
            if (msg === '/m') {
                <% if (player.permission == 'admin') { %>
                    socket.emit('admin_request_word_roles');
                <% } else { %>
                    // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    var $msgArea = $('#chatMessages');
                    $msgArea.append('<div class="chat-message-wrapper other"><div class="chat-message-bubble" style="background:#ffcccc;"><span class="chat-message-name" style="color:#c00;">System:</span> ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div></div>');
                    $msgArea[0].scrollTop = $msgArea[0].scrollHeight;
                <% } %>
                $('#chatInput').val('');
                return;
            }
            
            var messageData = { 
                message: msg, 
                playerName: '<%= player.name %>' 
            };
            if (replyingTo) { // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
                messageData.replyTo = replyingTo;
                replyingTo = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
                $('#replyPreview').hide(); // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                $('#replyPreview .reply-player-name').empty();
                $('#replyPreview .reply-message-content').empty();
            }
            socket.emit('sendMessage', messageData);
            $('#chatInput').val('');
            $('#chatInput').focus();
            $('#chatUnreadDot').hide();
        }
    });

    socket.on('newMessage', function(data) {
        var $msgArea = $('#chatMessages');
        var isMyMessage = (data.playerName === '<%= player.name %>');

        // Sanitize name, message, and timestamp to prevent XSS
        var safeName = $('<div>').text(data.playerName).html();
        var safeMsg  = $('<div>').text(data.message).html();
        var timestamp = $('<div>').text(data.timestamp).html();

        // Create a wrapper div for each message to control its alignment
        var $messageWrapper = $('<div class="chat-message-wrapper ' + (isMyMessage ? 'self' : 'other') + '" data-message-id="' + data.messageId + '"></div>');
        var $bubble = $('<div class="chat-message-bubble"></div>');
        var $info = $('<div class="chat-message-info"></div>');

        // Apply background color with transparency for other messages
        if (!isMyMessage && data.color) {
            $bubble.css('background-color', data.color + '33'); // 20% opacity for background
        }
        
        // Add reply indicator if this message is a reply
        if (data.replyTo) {
            var replyColor = (data.replyTo.name === '<%= player.name %>') ? '#333' : (data.replyTo.color || '#000');
            $bubble.append(
                '<span class="reply-to-text">' +
                    '<span class="reply-indicator">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö </span>' +
                    '<span class="reply-name" style="color: ' + replyColor + ';">' + $('<div>').text(data.replyTo.name).html() + ':</span> ' + 
                    $('<div>').text(data.replyTo.content).html() +
                '</span>'
            );
        }

        // Append name and message content to the bubble
        $bubble.append('<span class="chat-message-name" style="color: ' + (isMyMessage ? '#333' : (data.color || '#000')) + ';">' + safeName + ':</span> ' + safeMsg);
        
        // Append timestamp to info div
        $info.append(timestamp);

        // Assemble the message
        $messageWrapper.append($bubble, $info);
        $msgArea.append($messageWrapper);

        // Auto-scroll to the bottom of the chat
        $msgArea[0].scrollTop = $msgArea[0].scrollHeight;

        // Show unread dot and play sound if chat is hidden
        if (!$('#chatBox').is(':visible')) {
            $('#chatUnreadDot').show();
        }
        // Always play popup sound for new messages (if not my message)
        if (!isMyMessage) {
            soundNotify('popup');
        }
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà bubble ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
    $(document).on('click', '.chat-message-bubble', function() {
        var $wrapper = $(this).closest('.chat-message-wrapper');
        var messageId = $wrapper.data('message-id');
        
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å DOM ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤
        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô DOM ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ
        var playerName = $wrapper.find('.chat-message-name').text().replace(':', '').trim();
        var messageContent = $(this).contents().filter(function() {
            return this.nodeType === 3 || (this.nodeType === 1 && $(this).is(':not(.chat-message-name, .reply-to-text)'));
        }).text().trim(); // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ text node ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö reply-to-text

        // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡πá‡∏ô reply ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å reply ‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö reply)
        var $replyToText = $wrapper.find('.reply-to-text');
        if ($replyToText.length) {
            var originalReplyName = $replyToText.find('.reply-name').text().replace(':', '').trim();
            var originalReplyContent = $replyToText.contents().filter(function() {
                return this.nodeType === 3 || (this.nodeType === 1 && $(this).is(':not(.reply-indicator, .reply-name)'));
            }).text().trim();
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà reply ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ reply ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô
            playerName = originalReplyName;
            messageContent = originalReplyContent;
            // ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ messageId ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏ï‡πà replyTo ‡∏à‡∏∞‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Ç‡∏≠‡∏á reply
        }

        replyingTo = {
            id: messageId, // ID ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà reply to)
            name: playerName,
            content: messageContent.split('\n')[0] // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        };

        $('#replyPreview .reply-player-name').css('color', $wrapper.find('.chat-message-name').css('color')); // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        $('#replyPreview .reply-player-name').text(replyingTo.name);
        $('#replyPreview .reply-message-content').text(replyingTo.content);
        $('#replyPreview').show();
        $('#chatInput').focus();
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
    $(document).on('click', '#replyPreview .reply-cancel-btn', function() {
        replyingTo = null;
        $('#replyPreview').hide();
        $('#replyPreview .reply-player-name').empty();
        $('#replyPreview .reply-message-content').empty();
    });

    // ==================== NOTIFICATION SYSTEM ====================
function showNotification(message, type = 'info', duration = 5000) {
    const notification = $('<div class="notification ' + type + '">' + message + '</div>');
    $('#notificationCenter').append(notification);
    
    setTimeout(() => {
        notification.fadeOut(300, function() { $(this).remove(); });
    }, duration);
}

// NOTE: ‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô socket listeners ‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
// Notifications ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å main listeners ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏ó‡∏ô

    // ===== GM Quick Reply System =====
    <% if (player.role === '‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Å‡∏°') { %>
    var selectedMessageId = null; // ID ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ï‡∏≠‡∏ö
    
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ï‡∏≠‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GM)
    $(document).on('click', '.chat-message-wrapper.other .chat-message-bubble', function(e) {
        e.stopPropagation();
        var $wrapper = $(this).closest('.chat-message-wrapper');
        var messageId = $wrapper.data('message-id');
        var playerName = $wrapper.find('.chat-message-name').text().replace(':', '').trim();
        
        // ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° System
        if (playerName === 'System') return;
        
        // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤
        $('.chat-message-wrapper').removeClass('gm-selected');
        
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ
        $wrapper.addClass('gm-selected');
        selectedMessageId = messageId;
        
        // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏´‡∏ô
        var msgPreview = $(this).text().substring(0, 50);
        $('.gm-quick-label').html('üéØ ‡∏ï‡∏≠‡∏ö: <span style="color:#f6e05e;">' + playerName + '</span>');
    });
    
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.chat-message-bubble, .gm-reply-btn').length) {
            $('.chat-message-wrapper').removeClass('gm-selected');
            selectedMessageId = null;
            $('.gm-quick-label').html('üé≠ ‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô:');
        }
    });
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô
    $('.gm-reply-btn').on('click', function() {
        var replyType = $(this).data('reply'); // 'yes', 'no', 'maybe'
        
        if (!selectedMessageId) {
            // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            Swal.fire({
                icon: 'info',
                title: 'üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ',
                html: '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà <strong>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</strong> ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô<br>‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô',
                background: '#1e1e1e',
                color: '#fff',
                timer: 3000,
                showConfirmButton: false
            });
            return;
        }
        
        // ‡∏™‡πà‡∏á GM reaction ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        socket.emit('gmReaction', {
            targetMessageId: selectedMessageId,
            reactionType: replyType,
            playerName: '<%= player.name %>'
        });
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        $('.chat-message-wrapper').removeClass('gm-selected');
        selectedMessageId = null;
        $('.gm-quick-label').html('üé≠ ‡∏ï‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô:');
    });
    <% } %>
    
    // ‡∏£‡∏±‡∏ö GM reaction ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    socket.on('gmReactionReceived', function(data) {
        var $targetMsg = $('.chat-message-wrapper[data-message-id="' + data.targetMessageId + '"]');
        if ($targetMsg.length) {
            // ‡∏•‡∏ö reaction ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            $targetMsg.find('.gm-reaction').remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° reaction ‡πÉ‡∏´‡∏°‡πà
            var emoji, reactionClass;
            if (data.reactionType === 'yes') {
                emoji = '‚úÖ';
                reactionClass = 'yes';
            } else if (data.reactionType === 'no') {
                emoji = '‚ùå';
                reactionClass = 'no';
            } else {
                emoji = 'ü§î';
                reactionClass = 'maybe';
            }
            
            $targetMsg.find('.chat-message-bubble').append(
                '<span class="gm-reaction ' + reactionClass + '">' + emoji + '</span>'
            );
            
            // Scroll to bottom
            var $msgArea = $('#chatMessages');
            $msgArea[0].scrollTop = $msgArea[0].scrollHeight;
        }
    });
});
</script>